import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, onSnapshot, 
  addDoc, updateDoc, query, deleteDoc 
} from 'firebase/firestore';
import { 
  getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken 
} from 'firebase/auth';
import { 
  Calendar, Clock, Plus, Utensils, Home, Camera, 
  CreditCard, CheckSquare, ChevronRight, Navigation, 
  Check, Plane, Info, Search, Map as MapIcon, Ship, Car, 
  Trash2, TrainFront, Mountain, Image as ImageIcon,
  ArrowRight, Bus, TramFront, Wallet, TrendingUp, ExternalLink, MapPin
} from 'lucide-react';

// --- Firebase é…ç½® ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : { apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: "" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'switzerland-trip-2026';

// --- å¸¸é‡èˆ‡é…è‰² ---
const CATEGORY_COLORS = {
  spot: 'bg-journal-green',
  food: 'bg-journal-red',
  transport: 'bg-journal-blue',
  hotel: 'bg-orange-200',
  flight: 'bg-red-400',
};

const CATEGORY_LABELS = {
  spot: 'æ™¯é»',
  food: 'ç¾é£Ÿ',
  transport: 'äº¤é€š',
  hotel: 'ä½å®¿',
  flight: 'èˆªç­'
};

const SWISS_DAYS = [
  { id: '2026-03-18', label: 'Day 1', date: '3/18' },
  { id: '2026-03-19', label: 'Day 2', date: '3/19' },
  { id: '2026-03-20', label: 'Day 3', date: '3/20' },
  { id: '2026-03-21', label: 'Day 4', date: '3/21' },
  { id: '2026-03-22', label: 'Day 5', date: '3/22' },
  { id: '2026-03-23', label: 'Day 6', date: '3/23' },
  { id: '2026-03-24', label: 'Day 7', date: '3/24' },
  { id: '2026-03-25', label: 'Day 8', date: '3/25' },
  { id: '2026-03-26', label: 'Day 9', date: '3/26' },
  { id: '2026-03-27', label: 'Day 10', date: '3/27' },
  { id: '2026-03-28', label: 'Day 11', date: '3/28' },
  { id: '2026-03-29', label: 'Day 12', date: '3/29' },
  { id: '2026-03-30', label: 'Day 13', date: '3/30' },
  { id: '2026-03-31', label: 'Day 14', date: '3/31' },
];

// --- UI çµ„ä»¶ ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-[1.5rem] shadow-[4px_4px_0px_#E0E5D5] border-2 border-[#E0E5D5] p-4 transition-transform active:scale-[0.98] ${className}`}>
    {children}
  </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
      <div className="bg-[#F7F4EB] w-full max-w-lg rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 shadow-2xl animate-in slide-in-from-bottom-10 overflow-y-auto max-h-[90vh]">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-bold text-[#555]">{title}</h2>
          <button onClick={onClose} className="p-2 bg-white rounded-full shadow-sm text-gray-400 transition-colors hover:bg-gray-50">âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
};

export default function App() {
  const [activeTab, setActiveTab] = useState('schedule');
  const [selectedDay, setSelectedDay] = useState('2026-03-18');
  const [user, setUser] = useState(null);
  const [schedules, setSchedules] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [isAddingItem, setIsAddingItem] = useState(false);
  const [isAddingExpense, setIsAddingExpense] = useState(false);

  // åŒ¯ç‡ (æš«å®š 1 CHF = 36 TWD)
  const EXCHANGE_RATE = 36.5;

  // Firebase åˆå§‹åŒ–
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth failed:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const scheduleRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
    const unsubSchedule = onSnapshot(scheduleRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setSchedules(data.sort((a, b) => a.time.localeCompare(b.time)));
    });

    const expenseRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
    const unsubExpense = onSnapshot(expenseRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setExpenses(data);
    });

    return () => {
      unsubSchedule();
      unsubExpense();
    };
  }, [user]);

  const currentItems = useMemo(() => schedules.filter(s => s.date === selectedDay), [schedules, selectedDay]);
  
  const activeIndex = useMemo(() => {
    const now = new Date();
    const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    const idx = currentItems.findIndex(item => item.time > currentTimeStr);
    return idx === -1 ? currentItems.length - 1 : Math.max(0, idx - 1);
  }, [currentItems]);

  // æ–°å¢è¡Œç¨‹è™•ç†
  const handleAddItem = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newItem = {
      date: selectedDay,
      time: formData.get('time'),
      title: formData.get('title'),
      category: formData.get('category'),
      note: formData.get('note'),
      googleMapUrl: formData.get('googleMapUrl'),
      duration: formData.get('duration') || '60',
      // åˆ†æ®µå°è¦½é è¨­æ¨¡æ“¬ï¼Œå¯¦å‹™ä¸Šå¯è®“ç”¨æˆ¶ç·¨è¼¯
      legs: [
        { mode: 'train', from: 'èµ·é»ç«™', to: 'çµ‚é»ç«™', time: formData.get('duration') || '60' }
      ]
    };
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'schedules'), newItem);
    setIsAddingItem(false);
  };

  const handleAddExpense = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const amount = parseFloat(formData.get('amount'));
    const newItem = {
      title: formData.get('title'),
      amount: amount,
      currency: 'CHF',
      category: formData.get('category'),
      date: new Date().toISOString().split('T')[0]
    };
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), newItem);
    setIsAddingExpense(false);
  };

  const deleteItem = async (coll, id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
  };

  // --- è¦–åœ–çµ„ä»¶ ---

  const TransportLeg = ({ mode, from, to, time }) => (
    <div className="flex items-center gap-3 bg-[#F7F4EB] p-3 rounded-2xl border border-dashed border-[#E0D8C3] mb-2">
      <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-journal-blue shadow-sm">
        {mode === 'train' ? <TrainFront size={16} /> : mode === 'bus' ? <Bus size={16} /> : mode === 'cable' ? <Mountain size={16} /> : <Plane size={16} />}
      </div>
      <div className="flex-1 flex items-center justify-between text-[11px] font-bold text-[#666]">
        <div className="flex items-center gap-1">
          <span className="text-journal-blue">{from}</span>
          <ArrowRight size={10} className="text-gray-300" />
          <span className="text-journal-green">{to}</span>
        </div>
        <span className="bg-white px-2 py-0.5 rounded-full shadow-xs">{time} åˆ†</span>
      </div>
    </div>
  );

  const ScheduleView = () => (
    <div className="space-y-6 animate-fade-in">
      <div className="flex gap-4 overflow-x-auto pb-6 no-scrollbar -mx-6 px-6">
        {SWISS_DAYS.map((day) => (
          <button 
            key={day.id}
            onClick={() => setSelectedDay(day.id)}
            className={`flex-shrink-0 flex flex-col items-center justify-center min-w-[70px] h-[70px] rounded-[1.5rem] font-black transition-all border-2 ${
              selectedDay === day.id ? 'bg-[#9BAEBC] text-white border-[#9BAEBC] shadow-lg scale-110' : 'bg-white text-gray-300 border-gray-50'
            }`}
          >
            <span className="text-[10px] uppercase opacity-80">{day.label}</span>
            <span className="text-sm tracking-tighter">{day.date}</span>
          </button>
        ))}
      </div>

      <div className="relative pl-14 space-y-12 mb-32">
        <div className="absolute left-[1.6rem] top-2 bottom-2 w-1.5 bg-[#E0D8C3] rounded-full" />
        
        {currentItems.map((item, index) => (
          <div key={item.id} className="relative">
            <div className={`absolute -left-[3.15rem] top-1 z-10 w-12 h-12 rounded-full border-4 border-[#F7F4EB] flex items-center justify-center shadow-sm ${
              index < activeIndex ? 'bg-journal-green' : index === activeIndex ? 'bg-[#9BAEBC] animate-bounce' : 'bg-[#E0D8C3]'
            }`}>
              {index < activeIndex ? <Check size={20} className="text-white" strokeWidth={4} /> : index === activeIndex ? <div className="text-2xl">ğŸƒ</div> : <div className="w-3 h-3 rounded-full bg-white/40" />}
            </div>

            <div className="flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-base font-black text-[#9BAEBC]">{item.time}</span>
                  <span className="text-[10px] bg-journal-sand/40 text-journal-green px-3 py-1 rounded-full font-black uppercase">ç¸½æ™‚ç¨‹ {item.duration} min</span>
                </div>
                <button onClick={() => deleteItem('schedules', item.id)} className="text-gray-200 hover:text-red-300 transition-colors"><Trash2 size={16} /></button>
              </div>
              
              <Card className="flex flex-col gap-4 relative overflow-hidden group">
                <div className={`absolute top-0 right-0 w-2.5 h-full rounded-r-[1.3rem] ${CATEGORY_COLORS[item.category] || 'bg-gray-200'}`} />
                <div className="pr-6">
                  <h3 className="font-black text-xl text-[#555] flex items-center gap-2">
                    {item.category === 'transport' && <TrainFront size={20} className="text-journal-blue" />}
                    {item.category === 'flight' && <Plane size={20} className="text-red-400" />}
                    {item.category === 'hotel' && <Home size={20} className="text-orange-300" />}
                    {item.title}
                  </h3>
                  
                  {/* åˆ†æ®µè©³æƒ… (å¦‚æœæœ‰åˆ†æ®µæ•¸æ“š) */}
                  {item.legs && item.legs.length > 0 && (
                    <div className="mt-3 space-y-1">
                      {item.legs.map((leg, lIdx) => (
                        <TransportLeg key={lIdx} {...leg} />
                      ))}
                    </div>
                  )}

                  <p className="text-xs text-gray-400 font-bold italic mt-2">"{item.note || 'äº«å—æ—…ç¨‹...'}"</p>
                </div>

                <div className="flex gap-3 mt-1">
                  {item.googleMapUrl && (
                    <a href={item.googleMapUrl} target="_blank" rel="noopener noreferrer" className="flex-1 flex items-center justify-center gap-2 text-xs bg-blue-50 text-blue-500 py-3 rounded-2xl font-black active:scale-95 transition-all shadow-sm">
                      <MapIcon size={14} strokeWidth={3} /> é–‹å•Ÿ Google Maps
                    </a>
                  )}
                  <button className="w-14 flex items-center justify-center bg-gray-50 text-gray-300 py-3 rounded-2xl active:scale-95 transition-all">
                    <ImageIcon size={18} />
                  </button>
                </div>
              </Card>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  const ExpenseView = () => {
    const totalCHF = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    const totalTWD = totalCHF * EXCHANGE_RATE;

    return (
      <div className="space-y-6 animate-fade-in">
        <Card className="bg-gradient-to-br from-[#9BAEBC] to-[#7a8c99] text-white py-8 px-6 flex flex-col items-center border-none shadow-xl">
          <p className="text-[10px] font-black uppercase tracking-[0.3em] opacity-80 mb-1">Total Trip Expense</p>
          <p className="text-4xl font-black tracking-tighter mb-4">CHF {totalCHF.toLocaleString()}</p>
          <div className="w-full h-px bg-white/20 mb-4" />
          <div className="flex justify-between w-full text-sm font-bold opacity-90">
            <span>ä¼°ç®—å°å¹£ç¸½é¡</span>
            <span>â‰ˆ NT$ {totalTWD.toLocaleString()}</span>
          </div>
          <p className="text-[9px] mt-2 opacity-50 uppercase">Rate: 1 CHF = {EXCHANGE_RATE} TWD</p>
        </Card>

        <div className="flex justify-between items-center px-2">
          <h3 className="font-black text-lg text-[#555]">æ”¯å‡ºæ˜ç´°</h3>
          <button onClick={() => setIsAddingExpense(true)} className="bg-journal-green text-white px-4 py-2 rounded-xl text-xs font-black shadow-sm active:scale-95 transition-transform">+ æ–°å¢ç­†è·¡</button>
        </div>

        <div className="space-y-4">
          {expenses.map(ex => (
            <Card key={ex.id} className="flex justify-between items-center p-5">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-2xl bg-[#F7F4EB] text-journal-blue flex items-center justify-center">
                  <Wallet size={20} />
                </div>
                <div>
                  <p className="font-black text-[#555]">{ex.title}</p>
                  <p className="text-[10px] text-gray-400 font-bold">{ex.date} â€¢ {ex.category}</p>
                </div>
              </div>
              <div className="text-right">
                <p className="font-black text-xl text-[#555]">CHF {ex.amount}</p>
                <p className="text-[10px] text-gray-300 font-bold">â‰ˆ NT$ {Math.round(ex.amount * EXCHANGE_RATE)}</p>
              </div>
            </Card>
          ))}
          {expenses.length === 0 && <p className="text-center py-20 text-gray-300 font-bold italic">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„</p>}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#F7F4EB] bg-[radial-gradient(#D1D1D1_1px,transparent_1px)] bg-[length:24px_24px] text-[#555] font-sans pb-36">
      <header className="sticky top-0 z-40 bg-[#F7F4EB]/90 backdrop-blur-md px-6 py-8 flex justify-between items-center border-b border-gray-100">
        <div>
          <h1 className="text-2xl font-black tracking-tighter text-[#555] leading-none mb-1">SWISS DIARY</h1>
          <p className="text-[10px] text-journal-blue font-black uppercase tracking-[0.2em]">14 DAYS â€¢ 5 MEMBERS</p>
        </div>
        
        {/* æ–°å¢æŒ‰éˆ•ï¼šç§»å‹•è‡³å³ä¸Šæ–¹ */}
        <button 
          onClick={() => setIsAddingItem(true)}
          className="bg-journal-green text-white w-12 h-12 rounded-2xl shadow-lg flex items-center justify-center active:scale-90 transition-transform border-2 border-white"
        >
          <Plus size={24} strokeWidth={4} />
        </button>
      </header>

      <main className="px-6 py-4 max-w-lg mx-auto">
        {activeTab === 'schedule' ? <ScheduleView /> : activeTab === 'expense' ? <ExpenseView /> : (
          <div className="flex flex-col items-center justify-center py-24 text-gray-200">
            <Info size={40} className="mb-4 opacity-20" />
            <p className="font-bold tracking-widest text-sm uppercase">Developing: {activeTab}</p>
          </div>
        )}
      </main>

      {/* åº•éƒ¨å°è¦½ */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-gray-100 px-8 py-6 flex justify-between items-center z-50 rounded-t-[3.5rem] shadow-2xl max-w-lg mx-auto">
        {[
          { id: 'schedule', icon: Calendar, label: 'è¡Œç¨‹' },
          { id: 'booking', icon: CreditCard, label: 'æ†‘è­‰' },
          { id: 'expense', icon: Wallet, label: 'è¨˜å¸³' },
          { id: 'planning', icon: CheckSquare, label: 'æº–å‚™' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex flex-col items-center gap-2 transition-all duration-300 ${
              activeTab === tab.id ? 'text-journal-blue scale-110' : 'text-gray-200'
            }`}
          >
            <div className={`p-2 rounded-2xl transition-colors ${activeTab === tab.id ? 'bg-journal-blue/10' : ''}`}>
              <tab.icon size={26} strokeWidth={activeTab === tab.id ? 3 : 2} />
            </div>
          </button>
        ))}
      </nav>

      {/* æ–°å¢è¡Œç¨‹ Modal */}
      <Modal isOpen={isAddingItem} onClose={() => setIsAddingItem(false)} title="æ–°å¢å†’éšªè¡Œç¨‹">
        <form onSubmit={handleAddItem} className="space-y-5">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">é–‹å§‹æ™‚é–“</label>
              <input name="time" type="time" required className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
            </div>
            <div>
              <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">é ä¼°æ™‚ç¨‹ (min)</label>
              <input name="duration" type="number" placeholder="60" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
            </div>
          </div>
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">æ™¯é» / äº¤é€šé …ç›®</label>
            <input name="title" required placeholder="ä¾‹å¦‚ï¼šç­–é¦¬ç‰¹å°é®æ‹æ—¥å‡º" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
          </div>
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">é¡åˆ¥</label>
            <div className="grid grid-cols-5 gap-2">
              {Object.entries(CATEGORY_LABELS).map(([key, label]) => (
                <label key={key} className="cursor-pointer">
                  <input type="radio" name="category" value={key} defaultChecked={key==='spot'} className="hidden peer" />
                  <div className="peer-checked:bg-journal-blue peer-checked:text-white border-2 border-gray-100 bg-white p-2 rounded-xl text-center text-[10px] font-black transition-all">
                    {label}
                  </div>
                </label>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">Google Map é€£çµ (å¿…å¡«)</label>
            <input name="googleMapUrl" required type="url" placeholder="è²¼ä¸Šåœ°åœ–å°èˆªé€£çµ" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none text-xs text-blue-400 underline" />
          </div>
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">å‚™è¨»æé†’</label>
            <textarea name="note" rows="2" placeholder="ä¾‹å¦‚ï¼šè¨˜å¾—å¸¶åŠåƒ¹å¡..." className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
          </div>
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">ä¸Šå‚³æ™¯é»ç…§ç‰‡ (JPG)</label>
            <label className="w-full flex flex-col items-center justify-center border-2 border-dashed border-gray-200 bg-white p-6 rounded-3xl cursor-pointer hover:bg-gray-50 transition-colors">
              <Camera size={24} className="text-gray-300 mb-2" />
              <span className="text-[10px] font-bold text-gray-400">å¾ç›¸ç°¿é¸å–ç…§ç‰‡</span>
              <input type="file" accept="image/jpeg" className="hidden" />
            </label>
          </div>
          <button type="submit" className="w-full bg-journal-blue text-white py-5 rounded-[2rem] font-black shadow-xl active:scale-95 transition-transform tracking-widest">
            å­˜æª”è‡³ DAY {SWISS_DAYS.findIndex(d => d.id === selectedDay) + 1}
          </button>
        </form>
      </Modal>

      {/* æ–°å¢è¨˜å¸³ Modal */}
      <Modal isOpen={isAddingExpense} onClose={() => setIsAddingExpense(false)} title="ç´€éŒ„æ”¯å‡º">
        <form onSubmit={handleAddExpense} className="space-y-6">
          <div>
            <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">æ¶ˆè²»é …ç›®</label>
            <input name="title" required placeholder="ä¾‹å¦‚ï¼šå°‘å¥³å³°ç«è»Šç¥¨" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">é‡‘é¡ (CHF)</label>
              <input name="amount" type="number" step="0.01" required placeholder="0.00" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none" />
            </div>
            <div>
              <label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">é¡åˆ¥</label>
              <select name="category" className="w-full bg-white border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none">
                <option value="äº¤é€š">äº¤é€š</option>
                <option value="é£²é£Ÿ">é£²é£Ÿ</option>
                <option value="ä½å®¿">ä½å®¿</option>
                <option value="è³¼ç‰©">è³¼ç‰©</option>
              </select>
            </div>
          </div>
          <button type="submit" className="w-full bg-journal-green text-white py-5 rounded-[2rem] font-black shadow-xl active:scale-95 transition-transform tracking-widest">
            ç¢ºèªå…¥å¸³
          </button>
        </form>
      </Modal>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
      `}</style>
    </div>
  );
}
