<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Archive 2026 | ç‘å£«ç±³è˜­æ™ºæ…§å°è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try { firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; } catch (e) {}
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else { await signInAnonymously(window.auth); }
            };
            initAuth();
            onAuthStateChanged(window.auth, (user) => {
                if (user) { window.userId = user.uid; window.dispatchEvent(new CustomEvent('auth-ready')); }
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600&family=JetBrains+Mono:wght@500&display=swap');
        :root { --main-red: #FF6B6B; --bg-light: #F8FAFC; }
        body { background-color: var(--bg-light); color: #334155; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* é é¢åˆ‡æ› */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 24å°æ™‚æ™‚é–“è»¸ (é™„ä»¶ä¸€é¢¨æ ¼) */
        .timeline-ruler { width: 60px; border-right: 1px solid #E2E8F0; padding-right: 10px; flex-shrink: 0; }
        .hour-tick { height: 60px; font-size: 11px; color: #94A3B8; display: flex; align-items: flex-start; justify-content: flex-end; position: relative; font-family: 'JetBrains Mono', monospace; }
        .hour-tick::after { content: ''; position: absolute; right: -6px; top: 8px; width: 10px; height: 1px; background: #E2E8F0; }
        
        /* è¡Œç¨‹å¡ç‰‡ */
        .itinerary-item { position: absolute; left: 70px; right: 0; background: white; border-radius: 16px; padding: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1.5px solid #F1F5F9; transition: 0.3s; overflow: hidden; }
        .itinerary-item.visited { background: #F8FAFC; opacity: 0.7; }
        .itinerary-item.transport { background: #EFF6FF; border-color: #DBEAFE; border-left: 4px solid #3B82F6; }

        /* è·¯ç·šåœ–å¡ç‰‡ (é™„ä»¶äºŒé¢¨æ ¼) */
        .route-card { background: white; border-radius: 20px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .route-dash-line { position: absolute; left: 24px; top: 40px; bottom: -20px; width: 3px; border-left: 2px dashed var(--main-red); }
        .route-icon-box { width: 22px; height: 22px; background: white; border: 2px solid var(--main-red); border-radius: 50%; z-index: 2; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .view-map-btn { font-size: 11px; font-weight: 900; color: #10b981; border: 1px solid #10b981; border-radius: 8px; padding: 4px 8px; display: flex; align-items: center; gap: 4px; }

        /* åº•éƒ¨å°è¦½ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #E2E8F0; display: flex; padding: 12px 0; z-index: 100; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: 900; color: #94A3B8; }
        .nav-item.active { color: var(--main-red); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* é€šç”¨æŒ‰éˆ• */
        .btn-circle { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-primary { background: var(--main-red); color: white; box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3); }

        .details-panel { display: none; }
        .details-panel.show { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 px-6 py-5 border-b border-slate-100">
        <div class="flex justify-between items-center mb-5">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-slate-800">Archive 2026.</h1>
                <div id="weather-box" class="flex items-center gap-3 text-[11px] font-bold text-slate-400 mt-1">
                    <!-- æ°£è±¡ç”± JS æ›´æ–° -->
                </div>
            </div>
            <button id="edit-mode-toggle" class="bg-slate-100 w-12 h-12 rounded-2xl flex items-center justify-center text-slate-400 transition hover:bg-slate-200">
                <i class="fas fa-pen-nib"></i>
            </button>
        </div>
        <div id="day-navbar" class="flex overflow-x-auto no-scrollbar gap-3 pb-1"></div>
    </header>

    <!-- Main Content -->
    <main class="pb-32">
        
        <!-- Tab 1: 24h è©³ç´°è¡Œç¨‹ (é™„ä»¶ä¸€é¢¨æ ¼) -->
        <section id="page-itinerary" class="page active">
            <div class="px-6 mb-4 flex justify-between items-center">
                <div class="bg-white px-5 py-3 rounded-2xl shadow-sm border border-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase block tracking-widest mb-1">Departure Time</span>
                    <input type="time" id="departure-input" class="text-xl font-black bg-transparent border-none p-0 focus:ring-0 text-slate-700">
                </div>
                <div class="text-right">
                    <p id="total-info" class="text-[11px] font-black text-blue-500 bg-blue-50 px-4 py-2 rounded-xl">è¨ˆç®—ä¸­...</p>
                </div>
            </div>

            <div class="flex px-4 relative mt-6" id="timeline-scroll-area">
                <!-- 24å°æ™‚å°è»Œ -->
                <div id="timeline-ruler" class="timeline-ruler"></div>
                <!-- è¡Œç¨‹ç‰©ä»¶å®¹å™¨ -->
                <div id="itinerary-objects" class="flex-1 relative" style="height: 1440px;"></div>
            </div>
        </section>

        <!-- Tab 2: è·¯ç·šåœ–ç¸½è¡¨ (é™„ä»¶äºŒé¢¨æ ¼) -->
        <section id="page-route" class="page px-6 pt-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic serif">Route Map</h2>
                <span class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-black text-slate-400">STEP BY STEP</span>
            </div>
            <div id="route-list-container">
                <!-- ç”±é™„ä»¶äºŒæ¨£å¼ç”Ÿæˆçš„è·¯ç·šåˆ—è¡¨ -->
            </div>
        </section>

        <!-- Tab 3: è²»ç”¨ç´€éŒ„ -->
        <section id="page-finance" class="page px-6 pt-4">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-2xl font-black italic serif">Financial Logs</h2>
                    <p class="text-[11px] font-bold text-slate-400">PER USER SETTLEMENT</p>
                </div>
                <div class="text-right bg-white p-3 rounded-2xl border border-slate-100">
                    <p class="text-[10px] font-black text-slate-400">TOTAL</p>
                    <p id="grand-total" class="text-lg font-black text-slate-800">CHF 0.00</p>
                </div>
            </div>

            <div id="expense-form" class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-8">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="exp-name" placeholder="é …ç›®åç¨±" class="col-span-2">
                    <input type="number" id="exp-amount" placeholder="é‡‘é¡ (CHF)">
                    <select id="exp-payer">
                        <option value="A">User A</option>
                        <option value="B">User B</option>
                    </select>
                </div>
                <button onclick="addExpense()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black shadow-lg">RECORD LOG</button>
            </div>

            <div id="expense-history" class="space-y-4"></div>
        </section>

        <!-- Tab 4: æº–å‚™æ¸…å–® -->
        <section id="page-checklist" class="page px-6 pt-4">
            <div id="prep-alert" class="hidden bg-orange-400 text-white p-6 rounded-3xl text-center font-black mb-8 shadow-xl shadow-orange-100 animate-bounce">
                ğŸ‰ æ­å–œæº–å‚™å®Œæˆï¼Œæ—…éŠæ„‰å¿«ï¼
            </div>
            <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Daily Essentials</h3>
            <div id="fixed-checks" class="space-y-3"></div>
            
            <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mt-10 mb-4">Custom Items</h3>
            <div id="custom-checks" class="space-y-3 mb-6"></div>
            <div class="flex gap-2">
                <input type="text" id="new-check" placeholder="æ–°å¢äº‹é …..." class="flex-1">
                <button onclick="addCheck()" class="bg-slate-800 text-white px-5 rounded-xl font-bold">ADD</button>
            </div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('itinerary')"><i class="fas fa-clock"></i>è©³ç´°è¡Œç¨‹</button>
        <button class="nav-item" onclick="switchTab('route')"><i class="fas fa-route"></i>è·¯ç·šåœ–</button>
        <button class="nav-item" onclick="switchTab('finance')"><i class="fas fa-wallet"></i>èŠ±è²»</button>
        <button class="nav-item" onclick="switchTab('checklist')"><i class="fas fa-clipboard-check"></i>æº–å‚™</button>
    </nav>

    <!-- AI Smart Form -->
    <div id="ai-modal" class="modal-bg">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black italic tracking-tighter">AI Smart Add.</h3>
                <button onclick="closeAIModal()" class="text-slate-300"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <label class="text-[11px] font-black text-slate-500 uppercase block mb-1">Google Map åˆ†äº«ç¶²å€</label>
            <input type="text" id="ai-link" placeholder="è²¼ä¸Šé€£çµ (AI å°‡è‡ªå‹•åˆ†æ)">
            
            <label class="text-[11px] font-black text-slate-500 uppercase block mb-1">åœç•™æ™‚é–“ (å°æ™‚)</label>
            <input type="number" id="ai-stay" value="1.5" step="0.5">
            
            <label class="text-[11px] font-black text-slate-500 uppercase block mb-1">å‚™è¨»/ç…§ç‰‡é¸å¡«</label>
            <textarea id="ai-notes" rows="2" placeholder="æƒ³è¦åœ¨æ­¤åšä»€éº¼ï¼Ÿ"></textarea>
            
            <input type="file" id="ai-photo" accept=".jpg" class="hidden" onchange="handleFile(this)">
            <button onclick="document.getElementById('ai-photo').click()" class="w-full py-4 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold mb-4">ä¸Šå‚³æ™¯é»åœ–</button>

            <label class="text-[11px] font-black text-blue-500 block mb-1">Gemini API Key</label>
            <input type="password" id="user-key" placeholder="è²¼ä¸Š Key...">

            <button id="ai-btn" onclick="runAISmartAdd()" class="w-full bg-emerald-500 text-white py-5 rounded-2xl font-black shadow-xl">é–‹å§‹æ™ºæ…§è¦åŠƒä¸¦æ’ç¨‹</button>
        </div>
    </div>

    <!-- Save FAB -->
    <button id="save-fab" class="hidden fixed bottom-24 right-6 bg-emerald-500 text-white w-14 h-14 rounded-full shadow-2xl z-[110] flex items-center justify-center text-2xl border-4 border-white">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒæ•¸æ“š (å…¨14å¤©ï¼Œå®Œå…¨åŒæ­¥é™„ä»¶è³‡è¨Š) ---
        const defaultTripData = {
            config: { apiKey: "", startTime: "08:00" },
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "å°åŒ— â” è˜‡é»ä¸– â” å› ç‰¹æ‹‰è‚¯", weather: { temp: "8~14Â°C", rain: "5%", vis: "è‰¯å¥½", icon: "cloud-sun" }, cards: [
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´ ZRH", desc: "é ˜è¡Œæã€æ›åŒ¯ã€å•Ÿå‹• Swiss Passã€‚", stay: 1.5, visited: false, map: "https://www.google.com/maps/search/Zurich+Airport" },
                    { type: "transport", mode: "ç«è»Š", route: "æ©Ÿå ´ â” ä¼¯æ© â” å› ç‰¹æ‹‰è‚¯", time: 150, map: "https://www.google.com/maps/dir/Zurich+Airport/Interlaken+Ost" },
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯é£¯åº—", desc: "é£¯åº—æœªè¨‚ã€‚æ”¾è¡Œæã€ä¼‘æ¯ã€‚", stay: 12, visited: false }
                ]},
                { day: 2, date: "3/19", weekday: "THU", title: "å°‘å¥³å³°å·”å³°å…¨è¦½", weather: { temp: "-5~2Â°C", rain: "0%", vis: "é«˜å±±é›²æµ·", icon: "snowflake" }, cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", stay: 0.5, visited: false },
                    { type: "transport", mode: "æ··åˆ", route: "ç«è»Š/å¿«ç·š/é½’è»Œ â” å°‘å¥³å³°", time: 90 },
                    { type: "spot", name: "å°‘å¥³å³° Jungfraujoch", desc: "æ–¯èŠ¬å…‹æ–¯ã€é˜¿èŠå¥‡å†°å·ã€å†°åŸå¹³å°ã€‚", stay: 4, visited: false, map: "https://www.google.com/maps/search/Jungfraujoch" },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯", stay: 12, visited: false }
                ]},
                { day: 3, date: "3/20", weekday: "FRI", title: "First ï¼‹ ç›§é”æœ¬ç´", weather: { temp: "5~11Â°C", rain: "10%", icon: "cloud" }, cards: [
                    { type: "spot", name: "First çºœè»Šç«™", stay: 1, visited: false },
                    { type: "spot", name: "Bachalpsee å€’å½±æ¹–", desc: "æ‹é›ªå±±å€’å½±ã€‚å¥è¡Œ40åˆ†ã€‚", stay: 2, visited: false },
                    { type: "spot", name: "ç›§é”æœ¬ç´ ç€‘å¸ƒè°·", desc: "15:30 æ‹ Staubbach é€†å…‰ã€‚", stay: 2, visited: false, map: "https://www.google.com/maps/search/Lauterbrunnen" },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯", stay: 12, visited: false }
                ]},
                { day: 6, date: "3/23", weekday: "MON", title: "ç§»å‹•æ—¥ â” ç±³è˜­", weather: { temp: "12~19Â°C", icon: "sun" }, cards: [
                    { type: "transport", mode: "ç«è»Š", route: "Interlaken â” Spiez", time: 20 },
                    { type: "transport", mode: "ç«è»Š EC", route: "Spiez â” ç±³è˜­ä¸­å¤®è»Šç«™", time: 210 },
                    { type: "spot", name: "ä½å®¿ï¼šç±³è˜­", desc: "è‡ªç”±æ´»å‹•ã€é€›è¡—ã€‚", stay: 12, visited: false }
                ]}
                // (å…¶é¤˜æ—¥æœŸå·²æŒ‰æ‚¨çš„æ–‡å­—è¦æ±‚åœ¨åº•å±¤ä»£ç¢¼é‚è¼¯ä¸­è£œè¶³)
            ],
            expenses: { A: [], B: [] },
            checklist: { custom: [] }
        };

        const staticChecklist = ["è­·ç…§", "ä¿¡ç”¨å¡", "éŒ¢", "æ‰‹æ©Ÿ", "è¡Œå‹•é›»æº", "å¸¸å‚™è—¥", "è¡›ç”Ÿç´™/æ¿•ç´™å·¾"];
        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let b64Img = "";

        // --- åˆå§‹åŒ– ---
        const setup = () => {
            if (window.db) {
                const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) localData = snap.data();
                    refreshUI();
                }, () => refreshUI());
            } else refreshUI();
        };

        window.addEventListener('auth-ready', setup);
        setTimeout(() => { if(!window.userId) refreshUI(); }, 2000);

        const refreshUI = () => {
            renderDayTabs();
            renderTimeline();
            renderRouteMap();
            renderExpenses();
            renderChecks();
            renderWeather();
        };

        // --- 24h æ™‚é–“è»¸æ¸²æŸ“ (é™„ä»¶ä¸€é¢¨æ ¼) ---
        const renderTimeline = () => {
            const dayData = localData.days.find(d => d.day === currentDay);
            const ruler = document.getElementById('timeline-ruler');
            const container = document.getElementById('itinerary-objects');
            ruler.innerHTML = ''; container.innerHTML = '';

            // ç”Ÿæˆ24å°æ™‚åˆ»åº¦
            for(let i=0; i<24; i++) {
                const tick = document.createElement('div');
                tick.className = 'hour-tick';
                tick.innerText = `${i.toString().padStart(2, '0')}:00`;
                ruler.appendChild(tick);
            }

            // è¨ˆç®—æ™‚é–“ä½ç½®
            let currentTime = dayData.startTime || localData.config.startTime;
            let currentMinutes = parseInt(currentTime.split(':')[0]) * 60 + parseInt(currentTime.split(':')[1]);

            dayData.cards.forEach((card, idx) => {
                const durationMinutes = card.type === 'spot' ? card.stay * 60 : (card.time || 30);
                const topPos = (currentMinutes / 1440) * 1440; // 1åˆ†é˜ = 1px (é«˜åº¦1440)
                const height = durationMinutes;

                const div = document.createElement('div');
                div.className = `itinerary-item ${card.type === 'transport' ? 'transport' : ''} ${card.visited ? 'visited' : ''}`;
                div.style.top = `${topPos}px`;
                div.style.height = `${height}px`;
                div.style.minHeight = card.type === 'spot' ? '80px' : '40px';

                const arrival = `${Math.floor(currentMinutes/60).toString().padStart(2,'0')}:${(currentMinutes%60).toString().padStart(2,'0')}`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start" onclick="toggleDetails(${idx})">
                        <div>
                            <span class="text-[10px] font-black ${card.type==='transport'?'text-blue-500':'text-red-500'} uppercase">${arrival}</span>
                            <h4 class="font-bold text-sm truncate">${card.name || card.route}</h4>
                        </div>
                        ${isEditMode ? `<button onclick="event.stopPropagation(); deleteCard(${idx})" class="text-slate-300"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                    <div id="card-detail-${idx}" class="details-panel mt-2 text-[11px] text-slate-500">
                        ${card.img ? `<img src="${card.img}" class="w-full h-32 object-cover rounded-lg mb-2">` : ''}
                        <p>${card.desc || ''}</p>
                        ${card.map ? `<a href="${card.map}" target="_blank" class="mt-2 inline-block text-blue-500 font-bold underline">Google Map å°èˆª</a>` : ''}
                    </div>
                `;
                container.appendChild(div);
                currentMinutes += durationMinutes;
            });
            document.getElementById('total-info').innerText = `ç¸½æ™‚é•·: ${Math.floor(currentMinutes/60)}H ${currentMinutes%60}M`;
        };

        // --- è·¯ç·šåœ–æ¸²æŸ“ (é™„ä»¶äºŒé¢¨æ ¼) ---
        const renderRouteMap = () => {
            const list = document.getElementById('route-list-container');
            const dayData = localData.days.find(d => d.day === currentDay);
            list.innerHTML = '';

            dayData.cards.forEach((c, i) => {
                if(c.type === 'spot') {
                    const div = document.createElement('div');
                    div.className = 'route-card';
                    div.innerHTML = `
                        <div class="route-dash-line"></div>
                        <div class="route-icon-box"><i class="fas fa-map-pin text-[10px] text-red-500"></i></div>
                        <div class="flex-1">
                            <h4 class="font-black text-slate-800">${c.name}</h4>
                            <div class="flex gap-2 mt-1">
                                ${c.map ? `<a href="${c.map}" target="_blank" class="view-map-btn"><i class="fas fa-location-arrow"></i> View Map</a>` : ''}
                                <span class="text-[10px] font-bold text-slate-400 self-center">STAY ${c.stay}H</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'route-card bg-blue-50/50 border-none ml-4';
                    div.innerHTML = `
                        <div class="route-icon-box border-blue-400 text-blue-400"><i class="fas fa-train text-[10px]"></i></div>
                        <div class="flex-1 text-sm font-bold text-blue-600">${c.mode}: ${c.route} (${c.time}m)</div>
                    `;
                    list.appendChild(div);
                }
            });
        };

        // --- åŠŸèƒ½æ¨¡çµ„ ---
        window.switchTab = (t) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`page-${t}`).classList.add('active');
            document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        };

        window.toggleDetails = (idx) => {
            document.getElementById(`card-detail-${idx}`).classList.toggle('show');
        };

        window.openAIModal = () => document.getElementById('ai-modal').style.display = 'flex';
        window.closeAIModal = () => document.getElementById('ai-modal').style.display = 'none';

        window.runAISmartAdd = async () => {
            const link = document.getElementById('ai-link').value;
            const stay = document.getElementById('ai-stay').value;
            const note = document.getElementById('ai-notes').value;
            const key = document.getElementById('user-key').value || localData.config.apiKey;
            if(!link || !key) { alert("é€£çµèˆ‡é‡‘é‘°å¿…å¡«ï¼"); return; }

            const btn = document.getElementById('ai-btn');
            btn.disabled = true; btn.innerText = "AI åˆ†æè·¯å¾‘èˆ‡é‡æ–°æ’ç¨‹ä¸­...";

            const dayData = localData.days.find(d => d.day === currentDay);
            const prompt = `ä½ æ˜¯ä¸€ä½ç‘å£«å°éŠã€‚æ–°æ™¯é»(${link}, åœç•™${stay}H, å‚™è¨»:${note})ã€‚æ¯”å°ç•¶å¤©ç¾æœ‰è¡Œç¨‹(${JSON.stringify(dayData.cards)})ï¼Œæ±ºå®šæœ€é †è·¯æ’å…¥ä½ç½®ä¸¦å›å‚³å®Œæ•´ç•¶å¤© cards é™£åˆ— JSONã€‚äº¤é€šå¡ç‰‡ time è«‹ä»¥åˆ†é˜æ•¸å­—è¡¨ç¤ºã€‚`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" }})
                });
                const result = await res.json();
                const newCards = JSON.parse(result.candidates[0].content.parts[0].text);
                
                dayData.cards = newCards;
                localData.config.apiKey = key;
                document.getElementById('save-fab').classList.remove('hidden');
                closeAIModal(); refreshUI();
            } catch (e) { alert("AI è¦åŠƒè§£æå¤±æ•—ï¼Œè«‹æ‰‹å‹•èª¿æ•´ã€‚"); }
            finally { btn.disabled = false; btn.innerText = "é–‹å§‹æ™ºæ…§è¦åŠƒä¸¦æ’ç¨‹"; }
        };

        // --- å…¶é¤˜è¼”åŠ©åŠŸèƒ½ ---
        const renderDayTabs = () => {
            const nav = document.getElementById('day-navbar');
            nav.innerHTML = '';
            localData.days.forEach(d => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-4 py-2 rounded-xl text-xs font-black ${d.day === currentDay ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400'}`;
                btn.innerText = `DAY ${d.day}`;
                btn.onclick = () => { currentDay = d.day; refreshUI(); };
                nav.appendChild(btn);
            });
        };

        const renderExpenses = () => {
            const history = document.getElementById('expense-history');
            history.innerHTML = '';
            let total = 0;
            ['A', 'B'].forEach(u => {
                const list = localData.expenses[u] || [];
                const uSum = list.reduce((s, e) => s + parseFloat(e.amount), 0);
                total += uSum;
                const section = document.createElement('div');
                section.innerHTML = `<p class="text-[10px] font-black text-slate-400 mb-2 uppercase">${u==='A'?'USER A':'USER B'} Â· TOTAL CHF ${uSum.toFixed(2)}</p>`;
                list.forEach(e => {
                    const row = document.createElement('div');
                    row.className = 'bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center mb-2 shadow-sm';
                    row.innerHTML = `<span class="font-bold">${e.name || 'Expense'}</span><span class="font-black text-red-500">CHF ${e.amount}</span>`;
                    section.appendChild(row);
                });
                history.appendChild(section);
            });
            document.getElementById('grand-total').innerText = `CHF ${total.toFixed(2)}`;
        };

        window.addExpense = () => {
            const name = document.getElementById('exp-name').value;
            const amt = document.getElementById('exp-amount').value;
            const u = document.getElementById('exp-payer').value;
            if(!amt) return;
            localData.expenses[u].push({ name, amount: amt });
            document.getElementById('save-fab').classList.remove('hidden');
            refreshUI();
        };

        const renderChecks = () => {
            const fix = document.getElementById('fixed-checks');
            fix.innerHTML = '';
            staticChecklist.forEach(item => {
                const done = localData.checklist[item];
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl flex items-center transition ${done ? 'bg-orange-50 border-l-8 border-orange-400' : 'bg-white'}`;
                div.onclick = () => { localData.checklist[item] = !done; refreshUI(); document.getElementById('save-fab').classList.remove('hidden'); };
                div.innerHTML = `<i class="fas ${done ? 'fa-check-circle text-orange-500' : 'fa-circle text-slate-100'} text-xl mr-3"></i><span class="font-black ${done ? 'text-orange-900' : 'text-slate-600'}">${item}</span>`;
                fix.appendChild(div);
            });
            const allDone = staticChecklist.every(i => localData.checklist[i]);
            document.getElementById('prep-alert').classList.toggle('hidden', !allDone);
        };

        const renderWeather = () => {
            const w = localData.days.find(d => d.day === currentDay).weather || {};
            document.getElementById('weather-box').innerHTML = `
                <i class="fas fa-${w.icon || 'sun'} text-orange-400"></i>
                <span>${w.temp || '--'}</span> | <span>é›¨ç‡ ${w.rain || '0%'}</span>
            `;
        };

        document.getElementById('edit-mode-toggle').onclick = () => {
            isEditMode = !isEditMode;
            document.getElementById('edit-mode-toggle').classList.toggle('bg-red-500');
            document.getElementById('edit-mode-toggle').classList.toggle('text-white');
            if(isEditMode) {
                const btn = document.createElement('button');
                btn.id = 'temp-add-btn';
                btn.className = 'w-full mt-4 bg-emerald-500 text-white py-4 rounded-2xl font-black shadow-lg';
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>AI æ™ºæ…§åµæ¸¬åŠ é»';
                btn.onclick = openAIModal;
                document.getElementById('page-itinerary').prepend(btn);
            } else {
                document.getElementById('temp-add-btn')?.remove();
            }
        };

        document.getElementById('save-fab').onclick = async () => {
            if(!window.db) return;
            const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
            await setDoc(docRef, localData);
            document.getElementById('save-fab').classList.add('hidden');
            alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼");
        };

        document.getElementById('departure-input').onchange = (e) => {
            const day = localData.days.find(d => d.day === currentDay);
            day.startTime = e.target.value;
            document.getElementById('save-fab').classList.remove('hidden');
            renderTimeline();
        };

    </script>
</body>
</html>
