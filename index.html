<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swiss & Milan 2026 | å°èˆªç´šæ•¸ä½è¡Œç¨‹</title>
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) { console.error("Firebase Config Error", e); }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else { await signInAnonymously(window.auth); }
                    window.dispatchEvent(new CustomEvent('firebase-ready'));
                } catch (e) { window.dispatchEvent(new CustomEvent('firebase-error')); }
            };
            initAuth();
        } else { setTimeout(() => window.dispatchEvent(new CustomEvent('firebase-error')), 500); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600&display=swap');
        :root { --bg-base: #F4F7F9; --accent-transport: #3B82F6; --accent-spot: #1E293B; --accent-main: #EF4444; }
        body { background-color: var(--bg-base); color: #1E293B; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ™¯é»å¡ç‰‡ï¼šç™½è‰²å¯¦é«”è³ªæ„Ÿ */
        .spot-card { background: white; border-radius: 28px; width: 100%; margin: 16px 0; padding: 26px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,1); position: relative; }
        .spot-img { width: 100%; height: 240px; object-fit: cover; border-radius: 20px; margin-bottom: 18px; background: #E2E8F0; }
        
        /* å°èˆªæ—¥èªŒå¡ç‰‡ï¼šè—è‰²èƒŒæ™¯ï¼Œæ­¥é€²å¼ */
        .nav-log-card { background: #EBF5FF; border-radius: 28px; padding: 24px; border: 1.5px solid #DBEAFE; margin: 8px 0; position: relative; }
        .nav-step { position: relative; padding-left: 32px; margin-bottom: 20px; }
        .nav-step:last-child { margin-bottom: 0; }
        .nav-step::before { content: ''; position: absolute; left: 7px; top: 12px; width: 2px; height: calc(100% + 12px); background: #BFDBFE; border-left: 2px dashed #BFDBFE; }
        .nav-step:last-child::before { display: none; }
        .nav-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: white; border: 4px solid var(--accent-transport); border-radius: 50%; z-index: 2; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        
        .day-btn { flex: 0 0 auto; width: 72px; height: 95px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 22px; transition: all 0.3s; background: white; color: #64748B; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .day-btn.active { background: #1E293B; color: white; border-color: #1E293B; transform: translateY(-4px); box-shadow: 0 12px 20px rgba(30, 41, 59, 0.15); }
        
        input, textarea, select { background: #F8FAFC; border: 1.5px solid #E2E8F0; border-radius: 14px; padding: 16px; width: 100%; font-size: 14px; margin-bottom: 12px; }
        .btn-delete { background: #fee2e2; color: #ef4444; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: -10px; right: -10px; z-index: 20; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; border-radius: 40px; padding: 32px; max-height: 90vh; overflow-y: auto; }
        .smart-add-btn { background: #10b981; color: white; width: 100%; padding: 20px; border-radius: 24px; font-weight: 900; margin-bottom: 24px; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); letter-spacing: 1px; }
        .transport-icon-box { background: white; padding: 10px; border-radius: 12px; display: inline-flex; margin-right: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .photography-badge { background: #FFF7ED; color: #C2410C; border: 1px solid #FFEDD5; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 900; display: inline-flex; align-items: center; gap: 4px; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32">

    <header class="sticky top-0 z-50 bg-[#F4F7F9]/90 backdrop-blur-md pt-8 pb-4">
        <div class="px-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black serif text-slate-800 tracking-tighter italic">Archive 2026.</h1>
                <p class="text-[10px] uppercase tracking-[0.4em] text-slate-400 font-black mt-1">Swiss & Italy Navigation</p>
            </div>
            <button id="edit-toggle" class="bg-white shadow-lg p-3.5 rounded-2xl text-slate-400 hover:text-red-500 transition active:scale-90">
                <i class="fas fa-magic text-lg"></i>
            </button>
        </div>
        <div class="flex overflow-x-auto no-scrollbar gap-3 px-6 pb-2" id="date-navbar"></div>
    </header>

    <main class="px-6 mt-4" id="itinerary-content">
        <div class="flex flex-col justify-center items-center py-40 text-slate-300">
            <i class="fas fa-circle-notch animate-spin text-5xl mb-6"></i>
            <p class="text-lg font-black tracking-widest">LOADING DATABASE...</p>
        </div>
    </main>

    <!-- AI æ™ºæ…§å°èˆªè¦åŠƒè¦–çª— -->
    <div id="ai-modal" class="modal-bg">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-black text-slate-800 tracking-tighter">AI æ™ºæ…§è·¯é †</h3>
                    <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mt-1">Smart Auto-Reorder Logic</p>
                </div>
                <button onclick="closeAIModal()" class="bg-slate-100 p-2.5 rounded-full text-slate-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">Google Map åˆ†äº«ç¶²å€ (å¿…å¡«)</label>
            <input type="text" id="ai-link" placeholder="è²¼ä¸Šåœ°åœ–ç¶²å€...">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">åŠ å…¥æ—¥æœŸ</label>
                    <select id="ai-day-select"></select>
                </div>
                <div>
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">é è¨ˆåœç•™ (H)</label>
                    <input type="number" id="ai-duration" value="2" step="0.5">
                </div>
            </div>

            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">æ”å½±/è¡Œç¨‹å‚™è¨» (é¸å¡«)</label>
            <textarea id="ai-notes" rows="3" placeholder="ä¾‹å¦‚ï¼š16:00 æ‹æ—¥è½é€†å…‰..."></textarea>

            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">æ™¯é»ç…§ç‰‡ (JPG é¸å¡«)</label>
            <input type="file" id="ai-file" accept=".jpg,.jpeg" class="hidden" onchange="previewImage(this)">
            <button onclick="document.getElementById('ai-file').click()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-sm font-black bg-slate-50 mb-4 transition hover:bg-slate-100 active:scale-95">
                <i class="fas fa-camera mr-2 text-lg"></i> é¸æ“‡æª”æ¡ˆ
            </button>
            <img id="img-preview" class="w-full h-44 object-cover rounded-2xl mb-6 shadow-md" style="display:none;">

            <hr class="mb-6 border-slate-100">
            <label class="text-[11px] font-black text-blue-500 uppercase ml-1 block mb-2">Gemini API Key</label>
            <input type="password" id="user-api-key" placeholder="è²¼ä¸Šæ‚¨çš„ API Keyä»¥å•Ÿç”¨ AI...">

            <div id="ai-status" class="hidden text-xs font-bold p-4 rounded-2xl mb-4 bg-red-50 text-red-500 border border-red-100"></div>

            <button id="ai-submit-btn" onclick="processAIPlanning()" class="w-full bg-slate-900 py-5 rounded-2xl font-black text-white shadow-2xl flex items-center justify-center transition active:scale-95">
                <i class="fas fa-compass mr-3 text-lg text-blue-400"></i> é€å‡ºä¸¦ç”±å°éŠè‡ªå‹•æ’ç¨‹
            </button>
        </div>
    </div>

    <!-- Save Button -->
    <button id="save-btn" class="hidden fixed bottom-10 right-8 bg-emerald-500 text-white w-16 h-16 rounded-full shadow-2xl z-[100] flex items-center justify-center text-3xl transition active:scale-90 border-4 border-white">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æ ¸å¿ƒ 14 å¤©å°èˆªç´šæ•¸æ“š
        const defaultTripData = {
            config: { apiKey: "" },
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "ç©¿è¶Šæ¹–æ³Šï¼šé»ƒé‡‘åˆ—è»Šæ®µå…¥å¢ƒ", startTime: "12:30", cards: [
                    { type: "spot", name: "å°ç£æ©Ÿå ´", desc: "00:20 å‡ºç™¼ EK0387ã€‚æª¢æŸ¥è­·ç…§èˆ‡ Swiss Pass å•Ÿå‹•æ†‘è­‰ã€‚", img: "", duration: 1 },
                    { type: "transport", name: "é£›æ©Ÿè½åœ°èˆ‡å…¥å¢ƒ", navSteps: [
                        { mode: "é£›æ©Ÿ", desc: "12:25 æŠµé”è˜‡é»ä¸–æ©Ÿå ´ (ZRH)", time: "12h+" },
                        { mode: "æ­¥è¡Œ", desc: "è·Ÿéš¨æŒ‡æ¨™å‰å¾€ SBB æ©Ÿå ´ç«è»Šç«™", time: "10åˆ†" }
                    ], totalTime: "ç´„ 1 å°æ™‚" },
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´è»Šç«™", desc: "åœ¨æ­¤å•Ÿå‹• Swiss Passã€‚è¡Œæå¯é¸æ“‡å¯„é€è‡³ Interlakenï¼ˆéœ€ç¢ºèªï¼‰ã€‚", img: "", duration: 0.5 },
                    { type: "transport", name: "æ™¯è§€æ®µç§»å‹• (é»ƒé‡‘åˆ—è»Šç·š)", navSteps: [
                        { mode: "ç«è»Š IC8", desc: "ZÃ¼rich Flughafen â” ä¼¯æ© Bern (ä¸­å¤®æœˆå°)", stops: "3ç«™", time: "75åˆ†" },
                        { mode: "è½‰ä¹˜", desc: "ä¼¯æ©ç«™å…§è½‰å‘ 4 è™Ÿæœˆå°å¾€ Interlaken", time: "10åˆ†" },
                        { mode: "ç«è»Š IC61", desc: "ä¼¯æ© â” å› ç‰¹æ‹‰è‚¯æ±ç«™ Interlaken Ost", stops: "2ç«™", time: "55åˆ†" }
                    ], totalTime: "ç´„ 2.5 å°æ™‚", detail: "â€» æ­¤æ®µç‚ºé»ƒé‡‘åˆ—è»Šç·šï¼Œæ²¿é€”å¯è¦‹é¾ç–†æ¹–èˆ‡å¸ƒé‡Œæ©èŒ¨æ¹–ã€‚" },
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "Day 1 æŠµé”ã€‚å‰å¾€é£¯åº—æ”¾è¡Œæã€æ¡è²·é£Ÿç‰©ã€èª¿æ•´æ™‚å·®ã€‚", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", duration: 12, photography: "é»ƒæ˜æ™‚åˆ»å¯åœ¨è‰åªçœ‹æ»‘ç¿”å‚˜é™è½ã€‚" }
                ]},
                { day: 2, date: "3/19", weekday: "THU", title: "å°‘å¥³å³°ï¼šæ­æ´²ä¹‹å·”å…¨è¦½", startTime: "08:15", cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "æ™¨é–“å‡ºç™¼ã€‚ç©¿è‘—ä¿æš–è¡£ç‰©ï¼ˆé«˜æµ·æ‹”ï¼‰ã€‚", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001", duration: 0.5 },
                    { type: "transport", name: "å°‘å¥³å³°ç™»å±±å°èˆª", navSteps: [
                        { mode: "ç«è»Š R61", desc: "æ±ç«™ â” æ ¼æ—å¾·ç“¦è½‰é‹ç«™ Terminal", stops: "4ç«™", time: "35åˆ†" },
                        { mode: "æ­¥è¡Œ", desc: "æ­¥è¡Œ 3 åˆ†é˜è‡³ Eiger Express å…¥å£", time: "3åˆ†" },
                        { mode: "å¿«ç·šçºœè»Š", desc: "Eiger Express â” è‰¾æ ¼å†°æ²³ç«™ Glacier", stops: "1ç«™", time: "15åˆ†" },
                        { mode: "é½’è»Œç«è»Š", desc: "è‰¾æ ¼å†°æ²³ â” å°‘å¥³å³°ç«™ Jungfraujoch", stops: "1ç«™", time: "25åˆ†" }
                    ], totalTime: "ç´„ 1.5 å°æ™‚" },
                    { type: "spot", name: "æ–¯èŠ¬å…‹æ–¯è§€æ™¯å° / é˜¿èŠå¥‡å†°å·", desc: "11:00-14:00 æ‹æ”é‡é»ï¼šå†°åŸå¹³å°ã€å†°å·ä¿¯ç°ã€è¬å¹´é›ªæ™¯ã€‚", img: "https://images.unsplash.com/photo-1541410965313-d53b3c16ef17", duration: 4, photography: "å†°åŸå¹³å°å…‰ç·šå¼·çƒˆï¼Œå»ºè­°ä½¿ç”¨æ¸›å…‰é¡æˆ–åå…‰é¡ã€‚" },
                    { type: "transport", name: "åŸè·¯è¿”ç¨‹", navSteps: [
                        { mode: "é½’è»Œç«è»Š", desc: "å°‘å¥³å³°ç«™ â” è‰¾æ ¼å†°æ²³", time: "25åˆ†" },
                        { mode: "ç«è»Š", desc: "åŸè·¯ç¶“æ ¼æ—å¾·ç“¦è¿”å›å› ç‰¹æ‹‰è‚¯", time: "70åˆ†" }
                    ], totalTime: "ç´„ 1.5 å°æ™‚" },
                    { type: "spot", name: "ä½å®¿é£¯åº—ï¼šå› ç‰¹æ‹‰è‚¯", desc: "å¾…ç¢ºèªï¼Œä½å› ç‰¹æ‹‰è‚¯ã€‚", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001", duration: 12 }
                ]},
                { day: 3, date: "3/20", weekday: "FRI", title: "First å€’å½± â” ç›§é”æœ¬ç´", startTime: "08:00", cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "å‡ºç™¼å‰å¾€æ ¼æ—å¾·ç“¦ã€‚", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", duration: 0.5 },
                    { type: "transport", name: "å‰å¾€ First", navSteps: [
                        { mode: "ç«è»Š", desc: "æ±ç«™ â” æ ¼æ—å¾·ç“¦ç«™", stops: "4ç«™", time: "35åˆ†" },
                        { mode: "æ­¥è¡Œ", desc: "ç©¿éæ ¼æ—å¾·ç“¦ä¸»è¡—è‡³çºœè»Šç«™", time: "12åˆ†" },
                        { mode: "çºœè»Š", desc: "çºœè»Šç«™ â” First å±±é ‚", stops: "1ç«™", time: "25åˆ†" }
                    ], totalTime: "ç´„ 1.2 å°æ™‚" },
                    { type: "spot", name: "å·´å“ˆé˜¿çˆ¾æ™®æ¹– Bachalpsee", desc: "æ‹é›ªå±±å€’å½±ã€‚éœ€æ­¥è¡Œç´„ 40-50 åˆ†é˜ã€‚", img: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b", duration: 2.5, photography: "ä¸Šåˆç„¡é¢¨æ™‚å€’å½±æœ€æ¸…æ™°ã€‚" },
                    { type: "transport", name: "å‰å¾€ç€‘å¸ƒè°·", navSteps: [
                        { mode: "ç«è»Š", desc: "æ ¼æ—å¾·ç“¦ â” é›™æ¹–ç«™ ZweilÃ¼tschinen", time: "18åˆ†" },
                        { mode: "è½‰ä¹˜", desc: "åŒæœˆå°å°é¢è½‰ä¹˜å¾€ Lauterbrunnen", time: "12åˆ†" }
                    ], totalTime: "ç´„ 40 åˆ†é˜" },
                    { type: "spot", name: "ç›§é”æœ¬ç´ Lauterbrunnen", desc: "15:30-17:30 æ‹ Staubbach Falls é€†å…‰ã€æ‘èŠè‰åœ°ã€TrÃ¼mmelbach ç€‘å¸ƒã€‚", img: "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4", duration: 2.5, photography: "é€†å…‰æ™‚åˆ»ç€‘å¸ƒæœƒåƒç™¼å…‰çš„çµ²ç·šã€‚" }
                ]},
                { day: 4, date: "3/21", weekday: "SAT", title: "ç±³å€« â” é›ªæœ—å³° â” ç§˜å¢ƒå°é®", startTime: "08:30", cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "å‰å¾€ç›§é”æœ¬ç´ä¸­è½‰ã€‚", img: "", duration: 0.5 },
                    { type: "transport", name: "é€šå¾€é›²ç«¯å°èˆª", navSteps: [
                        { mode: "ç«è»Š", desc: "æ±ç«™ â” ç›§é”æœ¬ç´", time: "20åˆ†" },
                        { mode: "çºœè»Š", desc: "ç›§é”æœ¬ç´ â” GrÃ¼tschalp â” ç±³å€« MÃ¼rren", time: "25åˆ†" },
                        { mode: "æ­¥è¡Œ", desc: "ç©¿éç±³å€«å°é®è‡³é›ªæœ—å³°çºœè»Šç«™", time: "15åˆ†" },
                        { mode: "çºœè»Š", desc: "ç±³å€« â” Birg â” é›ªæœ—å³° Schilthorn", time: "15åˆ†" }
                    ], totalTime: "ç´„ 1.2 å°æ™‚" },
                    { type: "spot", name: "é›ªæœ—å³° Schilthorn", desc: "360åº¦ä¿¯ç°è‰¾æ ¼ã€åƒ§ä¾¶ã€å°‘å¥³ä¸‰å³°ã€‚", img: "", duration: 3 },
                    { type: "spot", name: "ç±³å€«å°é® MÃ¼rren", desc: "ç„¡è»Šå°é®ï¼Œæ•£æ­¥æ‹æ”æœ¨å±‹èˆ‡å±±æ™¯ã€‚", img: "", duration: 2 }
                ]},
                { day: 5, date: "3/22", weekday: "SUN", title: "åœ–æ©æ¹– â” æ–½çš®èŒ¨ â” æ£®æ—è—æ¹–", startTime: "09:00", cards: [
                    { type: "spot", name: "åœ–æ©æ¹–éŠèˆ¹ / æ–½çš®èŒ¨", desc: "æ‹æ”æ–½çš®èŒ¨åŸå ¡ Spiez èˆ‡é›ªå±±å€’å½±ã€‚", img: "", duration: 2, photography: "æ¹–å²¸æ˜¯æ‹åŸå ¡èˆ‡èƒŒæ™¯é›ªå±±çš„ç¶“å…¸è§’åº¦ã€‚" },
                    { type: "transport", name: "æ·±å…¥æ£®æ—è—æ¹–", navSteps: [
                        { mode: "ç«è»Š", desc: "Spiez â” Frutigen", time: "12åˆ†" },
                        { mode: "å…¬è»Š 230", desc: "Frutigen â” Blausee BE", time: "15åˆ†" }
                    ], totalTime: "ç´„ 40 åˆ†é˜" },
                    { type: "spot", name: "æ£®æ—è—æ¹– Blausee", desc: "å¦‚å¯¶çŸ³èˆ¬çš„æ¹›è—æ¹–æ°´ã€é±’é­šé¤ã€‚", img: "", duration: 3, photography: "åå…‰é¡å¯æ¶ˆé™¤æ°´é¢åå…‰ï¼Œæ‹å‡ºæ¸…æ¾ˆè¦‹åº•çš„æ•ˆæœã€‚" }
                ]},
                { day: 6, date: "3/23", weekday: "MON", title: "è·¨åœ‹ç§»å‹•ï¼šå› ç‰¹æ‹‰è‚¯ â” ç±³è˜­", startTime: "09:00", cards: [
                    { type: "transport", name: "è·¨åœ‹é•·é€”å°èˆª", navSteps: [
                        { mode: "ç«è»Š", desc: "Interlaken Ost â” Spiez", time: "20åˆ†" },
                        { mode: "ç«è»Š EC", desc: "Spiez â” Milano Centrale", time: "3.5-4h" }
                    ], totalTime: "ç´„ 4.5 å°æ™‚", detail: "â€» è·¨åœ‹ EC å¿…é ˆäº‹å…ˆåŠƒä½ã€‚" },
                    { type: "spot", name: "ç±³è˜­ä¸­å¤®è»Šç«™", desc: "å£¯éº—çš„æ³•è¥¿æ–¯å¼å»ºç¯‰ï¼Œæ”¾è¡Œæå¾Œè‡ªç”±æ´»å‹•ã€‚", img: "", duration: 2 },
                    { type: "spot", name: "ç±³è˜­é£¯åº—", desc: "è¾¦ç†å…¥ä½ã€‚", img: "", duration: 12 }
                ]},
                { day: 7, date: "3/24", weekday: "TUE", title: "ç±³è˜­å¸‚å€ï¼šå¤å…¸èˆ‡ç¾ä»£æ‹æ”", startTime: "10:00", cards: [
                    { type: "spot", name: "ç±³è˜­ä¸»æ•™åº§å ‚ Duomo", desc: "ä¸‹åˆå»£å ´å…‰ç·šæœ€å¥½ï¼Œå»ºè­°ç™»é ‚æ‹å°–å¡”ã€‚", img: "", duration: 3, photography: "15:00-17:00 å…‰ç·šæº«å’Œï¼Œé©åˆæ‹ç™½è‰²å¤§ç†çŸ³è³ªæ„Ÿã€‚" },
                    { type: "spot", name: "åŸƒé¦¬åŠªåŸƒèŠäºŒä¸–æ‹±å»Š", desc: "ç¶“å…¸åœ“é ‚ã€åç‰Œåº—ã€‚", img: "", duration: 1.5 },
                    { type: "spot", name: "Mercato Centrale Milano", desc: "æ™šé¤ç¾é£Ÿå¸‚é›†ã€‚", img: "", duration: 2 }
                ]},
                { day: 8, date: "3/25", weekday: "WED", title: "ç±³è˜­ â” ç­–é¦¬ç‰¹ï¼šåˆè¦‹é¦¬å³°", startTime: "09:30", cards: [
                    { type: "spot", name: "é‹æ²³å€ Naviglio Grande", desc: "ä¸Šåˆæ¼«æ­¥æ‹ç…§ã€‚", img: "", duration: 2 },
                    { type: "transport", name: "é€²å…¥å±±åŸ (å†°å·å¿«ç·šæ®µ)", navSteps: [
                        { mode: "ç«è»Š", desc: "Milano â” è²æ–¯æ™® Visp", time: "2.5h" },
                        { mode: "ç«è»Š (MGB)", desc: "Visp â” ç­–é¦¬ç‰¹ Zermatt", time: "1h" }
                    ], totalTime: "ç´„ 3.5 å°æ™‚", detail: "â€» Visp åˆ° Zermatt æ®µç‚ºå†°å·å¿«ç·šç²¾è¯ã€‚" },
                    { type: "spot", name: "Matterhorn Viewpoint (æ—¥è½)", desc: "17:30-19:00 æ‹æ”è—èª¿æ™‚åˆ»èˆ‡é¦¬ç‰¹æ´ªå³°é‡‘é ‚ã€‚", img: "", duration: 2, photography: "è—èª¿æ™‚åˆ» (Blue Hour) çš„å…‰å½±å°æ¯”æœ€è¿·äººã€‚" }
                ]},
                { day: 9, date: "3/26", weekday: "THU", title: "ç­–é¦¬ç‰¹å…¨æ™‚æ®µæ‹æ”è¨ˆç•«", startTime: "05:30", cards: [
                    { type: "spot", name: "KirchbrÃ¼cke æ©‹ (æ—¥å‡º)", desc: "06:00 æ‹æ”ã€Œé»ƒé‡‘é¦¬ç‰¹æ´ªå³°ã€ã€‚", img: "", duration: 1.5, photography: "ç¬¬ä¸€é“é™½å…‰ç‘åœ¨å±±å°–çš„ç¬é–“ã€‚" },
                    { type: "spot", name: "æ•™å ‚è‰å¡ / è€æ‘ Hinterdorf", desc: "æ•£æ­¥æ‹æ”å‚³çµ±ç“¦èŠå·æœ¨å±‹ã€‚", img: "", duration: 3 },
                    { type: "spot", name: "Matterhorn Viewpoint (æ˜Ÿç©º)", desc: "21:00-23:00 é•·æ›æ‹é¦¬ç‰¹æ´ªå³°æ˜Ÿè·¡ã€‚", img: "", duration: 3, photography: "å»ºè­°æ”œå¸¶è…³æ¶èˆ‡å¿«é–€ç·šã€‚" }
                ]},
                { day: 10, date: "3/27", weekday: "FRI", title: "Gornergrat â” Riffelsee å€’å½±æ¹–", startTime: "08:30", cards: [
                    { type: "transport", name: "é½’è»Œç«è»Šå°èˆª", navSteps: [
                        { mode: "ç«è»Š GGB", desc: "Zermatt GGB â” Gornergrat è§€æ™¯å°", time: "35åˆ†" }
                    ], totalTime: "35åˆ†", detail: "â€» ä¸Šå±±åå³å´ï¼Œé¦¬ç‰¹æ´ªå³°ä¸€è·¯ç›¸ä¼´ã€‚" },
                    { type: "spot", name: "Riffelsee å€’å½±æ¹–", desc: "Rotenboden ç«™ä¸‹å¡èµ° 10 åˆ†ã€‚æ‹æ”ç¶“å…¸å€’å½±ã€‚", img: "", duration: 2, photography: "ä¸Šåˆ 10:00 å‰é¢¨å¹³æµªéœï¼Œå€’å½±æœ€ç©©ã€‚" },
                    { type: "spot", name: "Gornergrat è§€æ™¯å°", desc: "é çœºè’™ç‰¹ç¾…èå³°èˆ‡å†°æ²³ã€‚", img: "", duration: 2 }
                ]},
                { day: 11, date: "3/28", weekday: "SAT", title: "äº”æ¹–å¥è¡Œï¼šå´é¢é¦¬ç‰¹æ´ªå³°", startTime: "09:00", cards: [
                    { type: "transport", name: "ç™»å±±çºœè»Šæ®µ", navSteps: [
                        { mode: "åœ°åº•çºœè»Š", desc: "Zermatt â” Sunnegga", time: "5åˆ†" },
                        { mode: "çºœè»Š", desc: "Sunnegga â” Blauherd", time: "10åˆ†" }
                    ], totalTime: "20åˆ†" },
                    { type: "spot", name: "Stellisee å€’å½±æ¹–", desc: "äº”æ¹–ä¸­æœ€ç¾çš„ä¸€å€‹ï¼Œæ‹å´é¢é¦¬å³°ã€‚", img: "", duration: 2 },
                    { type: "spot", name: "èŠ¬å¾·å€«æ‘ Findeln", desc: "ä¸‹å¡å¥è¡Œè‡³æ­¤ç”¨é¤ï¼Œæ™¯è‰²çµ•ä½³ã€‚", img: "", duration: 2 }
                ]},
                { day: 12, date: "3/29", weekday: "SUN", title: "ç­–é¦¬ç‰¹ï¼šå½ˆæ€§è£œæ‹æ—¥", startTime: "09:00", cards: [
                    { type: "spot", name: "å°é®æ•£æ­¥ / æ¡è²·", desc: "è²· LÃ¤derach å·§å…‹åŠ›ã€ç´€å¿µå“ã€ä¼‘æ¯ã€‚", img: "", duration: 8 }
                ]},
                { day: 13, date: "3/30", weekday: "MON", title: "ç­–é¦¬ç‰¹ â” è˜‡é»ä¸–æ©Ÿå ´", startTime: "08:00", cards: [
                    { type: "transport", name: "è¿”ç¨‹é•·é€”å°èˆª", navSteps: [
                        { mode: "ç«è»Š", desc: "Zermatt â” Visp â” Zurich Airport", time: "4h" }
                    ], totalTime: "4å°æ™‚" },
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´ / è³¦æ­¸", desc: "è¾¦ç†é€€ç¨…ã€å…ç¨…æ¡è²·ã€‚", img: "", duration: 3 }
                ]},
                { day: 14, date: "3/31", weekday: "TUE", title: "å¹³å®‰æŠµé”å°ç£", cards: [
                    { type: "spot", name: "æ¡ƒåœ’æ©Ÿå ´ (TPE)", desc: "16:10 æŠµé”ã€‚æ—…ç¨‹çµæŸã€‚", img: "", duration: 1 }
                ]}
            ]
        };

        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let uploadedImageBase64 = "";

        const getTransportIcon = (mode) => {
            const m = mode.toLowerCase();
            if (m.includes('æ­¥è¡Œ') || m.includes('èµ°')) return '<i class="fas fa-walking text-blue-400"></i>';
            if (m.includes('ç«è»Š')) return '<i class="fas fa-train text-blue-600"></i>';
            if (m.includes('çºœè»Š') || m.includes('å¿«ç·š')) return '<i class="fas fa-cable-car text-purple-600"></i>';
            if (m.includes('é£›æ©Ÿ')) return '<i class="fas fa-plane text-slate-500"></i>';
            return '<i class="fas fa-arrow-right text-blue-300"></i>';
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageBase64 = e.target.result;
                    document.getElementById('img-preview').src = uploadedImageBase64;
                    document.getElementById('img-preview').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        const renderNavBar = () => {
            const navbar = document.getElementById('date-navbar');
            const select = document.getElementById('ai-day-select');
            navbar.innerHTML = ''; select.innerHTML = '';
            localData.days.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `day-btn ${item.day === currentDay ? 'active' : ''}`;
                btn.onclick = () => { currentDay = item.day; renderNavBar(); renderContent(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                btn.innerHTML = `<span class="text-[9px] font-black uppercase opacity-60">Day</span><span class="text-2xl serif italic leading-none my-1">${item.day}</span><span class="text-[11px] font-black">${item.date}</span>`;
                navbar.appendChild(btn);

                const opt = document.createElement('option');
                opt.value = item.day; opt.innerText = `Day ${item.day} (${item.date})`;
                select.appendChild(opt);
            });
            select.value = currentDay;
        };

        const renderContent = () => {
            const data = localData.days.find(d => d.day === currentDay);
            const container = document.getElementById('itinerary-content');
            if(!data) return;

            let html = isEditMode ? `<button onclick="openAIModal()" class="smart-add-btn"><i class="fas fa-compass mr-2"></i>AI æ™ºæ…§å°è¦½ï¼šè¼¸å…¥é€£çµè‡ªå‹•è¦åŠƒè·¯é †</button>` : '';
            html += `<div class="mb-10"><h2 class="text-4xl font-black text-slate-800 serif italic leading-tight">${data.title}</h2><p class="mt-3 text-slate-400 font-black flex items-center gap-2"><i class="fas fa-regular fa-clock text-red-400"></i> PRESET DEPARTURE: ${data.startTime}</p></div>`;

            data.cards.forEach((card, idx) => {
                const delBtn = isEditMode ? `<button onclick="deleteCard(${idx})" class="btn-delete"><i class="fas fa-trash-alt text-[10px]"></i></button>` : '';
                
                if (card.type === 'spot') {
                    html += `
                        <div class="spot-card">
                            ${delBtn}
                            ${card.img ? `<img src="${card.img}" class="spot-img shadow-xl">` : ''}
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-slate-900 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">Location</div>
                                ${card.photography ? `<div class="photography-badge"><i class="fas fa-camera"></i> ${card.photography}</div>` : ''}
                                <span class="text-slate-300 text-xs font-black ml-auto">STAY ${card.duration}H</span>
                            </div>
                            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-3">${card.name}</h3>
                            <p class="text-slate-500 leading-relaxed text-[15px] font-medium">${card.desc}</p>
                        </div>`;
                } else if (card.type === 'transport') {
                    html += `
                        <div class="nav-log-card shadow-sm">
                            ${delBtn}
                            <div class="flex items-center justify-between mb-5">
                                <div class="text-[10px] font-black text-blue-500 uppercase tracking-widest"><i class="fas fa-route mr-2"></i>Navigation Log</div>
                                <div class="text-[11px] font-black text-blue-400">${card.totalTime || 'è½‰ä¹˜åˆ†æä¸­'}</div>
                            </div>
                            <div class="space-y-0">
                                ${(card.navSteps || []).map(step => `
                                    <div class="nav-step">
                                        <div class="nav-dot"></div>
                                        <div class="flex items-start">
                                            <div class="transport-icon-box">${getTransportIcon(step.mode)}</div>
                                            <div>
                                                <p class="text-[14px] font-bold text-slate-700">${step.mode}: ${step.desc}</p>
                                                <p class="text-[11px] text-blue-400 font-black mt-1 uppercase tracking-tighter">
                                                    ${step.stops ? `<i class="fas fa-ellipsis-v mr-1"></i> ${step.stops} Â· ` : ''}
                                                    <i class="fas fa-clock mr-1"></i> ${step.time}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${card.detail ? `<div class="mt-6 bg-white/50 p-3 rounded-xl text-[12px] text-blue-600 italic font-bold border border-blue-100">ğŸ’¡ æŒ‡å¼•ï¼š${card.detail}</div>` : ''}
                        </div>`;
                }
            });
            container.innerHTML = html;
        };

        window.openAIModal = () => { document.getElementById('ai-modal').style.display = 'flex'; };
        window.closeAIModal = () => { document.getElementById('ai-modal').style.display = 'none'; };
        window.deleteCard = (idx) => { localData.days.find(d => d.day === currentDay).cards.splice(idx, 1); document.getElementById('save-btn').classList.remove('hidden'); renderContent(); };

        window.processAIPlanning = async () => {
            const link = document.getElementById('ai-link').value.trim();
            const notes = document.getElementById('ai-notes').value.trim();
            const dayNum = parseInt(document.getElementById('ai-day-select').value);
            const duration = parseFloat(document.getElementById('ai-duration').value);
            const key = document.getElementById('user-api-key').value.trim() || localData.config.apiKey;
            const statusDiv = document.getElementById('ai-status');

            if (!link) { alert("è«‹è²¼ä¸Š Google Map ç¶²å€"); return; }
            if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
            
            const btn = document.getElementById('ai-submit-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>æ­£åœ¨åˆ†æåœ°ç†åº§æ¨™èˆ‡å°å¼•è·¯å¾‘...';
            statusDiv.style.display = 'none';

            localData.config.apiKey = key;
            const targetDay = localData.days.find(d => d.day === dayNum);
            const currentPlan = JSON.stringify(targetDay.cards);

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°éŠ AIã€‚åˆ†ææ–°éœ€æ±‚(Google Map: ${link}, å‚™è¨»: ${notes}, åœç•™: ${duration}H)
            ä¸¦èˆ‡ç¾æœ‰è¡Œç¨‹é †åº(${currentPlan})æ¯”å°åœ°ç†ä½ç½®ï¼Œæ±ºå®šæ–°æ™¯é»æœ€é †è·¯çš„æ’å…¥ä½ç½®ã€‚
            
            è¦æ±‚ï¼š
            1. äº¤é€šå¿…é ˆç‚º type: "transport" ä¸”åŒ…å«è©³ç´° navStepsã€‚
            2. navSteps æ ¼å¼ï¼š{"mode":"æ­¥è¡Œ/ç«è»Š/çºœè»Š","desc":"æè¿°èµ·é»â”çµ‚é»","stops":"åœé ç«™(é¸å¡«)","time":"æ™‚é–“"}ã€‚
            3. å›å‚³å®Œæ•´ç•¶å¤© cards é™£åˆ— JSONï¼Œåš´ç¦è§£é‡‹æ–‡å­—ã€‚`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "åŸ·è¡Œå°èˆªç´šæ™ºæ…§åŠ é»ä¸¦é‡æ–°æ’åº" }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const result = await response.json();
                const updatedCards = JSON.parse(result.candidates[0].content.parts[0].text);
                
                updatedCards.forEach(c => { if(c.type === 'spot' && !c.img && uploadedImageBase64) c.img = uploadedImageBase64; });

                targetDay.cards = updatedCards;
                document.getElementById('save-btn').classList.remove('hidden'); 
                closeAIModal(); currentDay = dayNum; renderNavBar(); renderContent();
            } catch (e) { statusDiv.innerText = "è¦åŠƒå¤±æ•—ï¼š" + e.message; statusDiv.style.display = 'block'; } 
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic mr-3"></i>é–‹å§‹å°èˆªè·¯å¾‘åˆ†æ'; }
        };

        document.getElementById('edit-toggle').onclick = () => { isEditMode = !isEditMode; document.getElementById('edit-toggle').classList.toggle('text-red-500'); renderContent(); };
        document.getElementById('save-btn').onclick = async () => {
            if(!window.db) return;
            try {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                await setDoc(docPath, localData);
                document.getElementById('save-btn').classList.add('hidden'); isEditMode = false; renderContent();
            } catch (e) { console.error(e); }
        };

        const loadData = () => {
            if (window.db) {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docPath, (doc) => { if (doc.exists()) localData = doc.data(); renderNavBar(); renderContent(); });
            } else { renderNavBar(); renderContent(); }
        };

        window.addEventListener('firebase-ready', loadData);
        window.addEventListener('firebase-error', loadData);
        setTimeout(() => { if(document.getElementById('itinerary-content').innerText.includes('åŒæ­¥')) loadData(); }, 3000);
    </script>
    <style> .fade-in { animation: fadeIn 0.8s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } </style>
</body>
</html>
