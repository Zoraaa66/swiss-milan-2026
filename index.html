<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archive 2026 | ç‘å£«èˆ‡ç±³è˜­æ™ºæ…§æŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try { firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; } catch (e) {}
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else { await signInAnonymously(window.auth); }
            };
            initAuth();
            onAuthStateChanged(window.auth, (user) => {
                if (user) { window.userId = user.uid; window.dispatchEvent(new CustomEvent('auth-ready')); }
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600&display=swap');
        :root { --main-coral: #FF6B6B; --main-blue: #3B82F6; --bg-soft: #F8FAFC; }
        body { background-color: var(--bg-soft); color: #334155; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* é é¢åˆ‡æ›æ•ˆæœ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡Œç¨‹å¡ç‰‡ */
        .spot-card { background: white; border-radius: 20px; padding: 16px; margin-bottom: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); position: relative; transition: all 0.2s; border: 1.5px solid transparent; }
        .spot-card.visited { background: #FFF7ED; border-color: #FED7AA; }
        .spot-card.visited .spot-title { color: #94A3B8; text-decoration: line-through; }
        
        /* å·¦å´è·¯å¾‘ç·š */
        .timeline-line { position: absolute; left: 18px; top: 0; bottom: 0; width: 3px; background: #E2E8F0; z-index: 0; }
        .timeline-line.active { background: #FB923C; }
        .timeline-item { position: relative; padding-left: 50px; }
        .timeline-dot { position: absolute; left: 11px; top: 22px; width: 18px; height: 18px; border-radius: 50%; background: white; border: 4px solid #CBD5E1; z-index: 2; transition: 0.3s; }
        .timeline-dot.visited { border-color: #FB923C; background: #FB923C; }
        .person-marker { position: absolute; left: 5px; top: 16px; font-size: 24px; color: #EA580C; z-index: 10; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #E2E8F0; display: flex; padding: 10px 0; z-index: 100; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: bold; color: #94A3B8; transition: 0.2s; }
        .nav-item.active { color: var(--main-coral); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* äº¤é€šå°èˆªå€å¡Š */
        .nav-link-card { background: #EFF6FF; border-radius: 16px; padding: 12px 16px; margin: 4px 0 12px 50px; border-left: 4px solid #3B82F6; }
        
        /* å¤©æ•¸é¸æ“‡å™¨ */
        .day-tab { flex: 0 0 auto; width: 65px; height: 80px; border-radius: 16px; background: white; border: 1px solid #E2E8F0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .day-tab.active { background: var(--main-coral); color: white; border-color: var(--main-coral); box-shadow: 0 8px 15px rgba(255, 107, 107, 0.2); }

        /* å±•é–‹å‹•ç•« */
        .details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .details.open { max-height: 1000px; padding-top: 12px; }

        /* è²»ç”¨æ¬„ä½æ¨£å¼ */
        .expense-row { display: flex; align-items: center; background: white; padding: 15px; border-radius: 16px; margin-bottom: 8px; border: 1px solid #F1F5F9; }
        
        /* æº–å‚™æ¸…å–®æ¨£å¼ */
        .check-item { display: flex; align-items: center; padding: 16px; border-radius: 16px; background: white; margin-bottom: 10px; transition: 0.3s; }
        .check-item.done { background: #FFF7ED; border-left: 6px solid #FB923C; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 px-6 py-4 border-b border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-slate-800">The Archive.</h1>
                <div id="header-weather" class="text-[10px] font-bold text-slate-400 mt-0.5 flex items-center gap-2">
                    <!-- æ°£è±¡ç”± JS æ›´æ–° -->
                </div>
            </div>
            <button id="edit-mode-toggle" class="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center text-slate-400">
                <i class="fas fa-edit"></i>
            </button>
        </div>
        <div id="day-navbar" class="flex overflow-x-auto no-scrollbar gap-3 pb-2"></div>
    </header>

    <!-- Content Pages -->
    <main class="px-6 pt-4 pb-32">
        
        <!-- Tab 1: è©³ç´°è¡Œç¨‹ -->
        <section id="page-itinerary" class="page active">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase block">é è¨ˆå‡ºç™¼</span>
                    <input type="time" id="departure-time-input" class="text-lg font-black bg-transparent border-none p-0 focus:ring-0 text-slate-700">
                </div>
                <div class="text-right">
                    <p id="total-travel-time" class="text-[11px] font-black text-blue-500 bg-blue-50 px-3 py-1 rounded-full inline-block">ç¸½è·¯ç¨‹: è®€å–ä¸­</p>
                </div>
            </div>

            <div id="itinerary-list" class="relative">
                <!-- è¡Œç¨‹ç”± JS ç”Ÿæˆ -->
            </div>

            <button id="add-smart-btn" class="hidden w-full mt-6 bg-emerald-500 text-white py-4 rounded-2xl font-black shadow-xl shadow-emerald-100 flex items-center justify-center gap-2">
                <i class="fas fa-magic"></i> AI æ™ºæ…§åŠ é»ä¸¦é‡æ–°æ’åº
            </button>
        </section>

        <!-- Tab 2: æ™¯é»è·¯ç·šç¸½è¡¨ (é™„ä»¶ä¸€é¢¨æ ¼) -->
        <section id="page-overview" class="page">
            <h2 class="text-xl font-black serif italic mb-6 text-slate-800">Route Overview</h2>
            <div id="overview-map-list" class="space-y-4">
                <!-- é¢¨æ ¼åŒ–åœ°åœ–æ¸…å–® -->
            </div>
        </section>

        <!-- Tab 3: è²»ç”¨ç´€éŒ„ -->
        <section id="page-expenses" class="page">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-xl font-black serif italic text-slate-800 text-title">Financial Logs</h2>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">ç¸½æ”¯å‡º</p>
                    <p id="grand-total-expense" class="text-xl font-black text-slate-800">CHF 0.00</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm mb-6">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-3">æ–°å¢æ”¯å‡º</p>
                <div class="space-y-3">
                    <input type="text" id="exp-name" placeholder="èŠ±è²»åç¨± (é¸å¡«)">
                    <div class="flex gap-2">
                        <input type="number" id="exp-amount" placeholder="é‡‘é¡ (å¿…å¡«)" class="flex-1">
                        <select id="exp-user" class="w-24">
                            <option value="user1">æ‚¨</option>
                            <option value="user2">æ—…ä¼´</option>
                        </select>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">è¨˜éŒ„èŠ±è²»</button>
                </div>
            </div>

            <div id="expense-list" class="space-y-2"></div>
        </section>

        <!-- Tab 4: è¡Œå‰æ¸…å–® -->
        <section id="page-prep" class="page">
            <div id="prep-congrats" class="hidden bg-orange-100 text-orange-700 p-5 rounded-3xl text-center font-black mb-6 border-2 border-orange-200 animate-bounce">
                ğŸ‰ æ­å–œæº–å‚™å®Œæˆï¼Œæ—…éŠæ„‰å¿«ï¼
            </div>

            <h3 class="text-sm font-black text-slate-400 uppercase mb-4 tracking-widest italic">æ¯æ—¥å›ºå®šæ”œå¸¶</h3>
            <div id="prep-list-fixed" class="space-y-2"></div>
            
            <h3 class="text-sm font-black text-slate-400 uppercase mt-8 mb-4 tracking-widest italic">è‡ªå®šç¾©æé†’</h3>
            <div id="prep-list-custom" class="space-y-2 mb-4"></div>
            <div class="flex gap-2">
                <input type="text" id="new-prep-item" placeholder="æ–°å¢æé†’äº‹é …..." class="flex-1">
                <button onclick="addPrepItem()" class="bg-slate-800 text-white px-4 rounded-xl font-bold">æ–°å¢</button>
            </div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('itinerary')"><i class="fas fa-calendar-alt"></i>è©³ç´°è¡Œç¨‹</button>
        <button class="nav-item" onclick="switchPage('overview')"><i class="fas fa-map-marked-alt"></i>è·¯ç·šåœ–</button>
        <button class="nav-item" onclick="switchPage('expenses')"><i class="fas fa-wallet"></i>èŠ±è²»</button>
        <button class="nav-item" onclick="switchPage('prep')"><i class="fas fa-suitcase"></i>æº–å‚™æ¸…å–®</button>
    </nav>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal-bg">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black tracking-tighter italic">Smart Add.</h3>
                <button onclick="closeAIModal()" class="text-slate-300"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Google Map é€£çµ (å¿…å¡«)</label>
            <input type="text" id="ai-link" placeholder="è²¼ä¸Šåˆ†äº«é€£çµ...">
            <label class="text-[10px] font-black text-slate-500 uppercase block mb-1">é è¨ˆåœç•™æ™‚é–“ (å°æ™‚)</label>
            <input type="number" id="ai-stay" value="1.5" step="0.5">
            <label class="text-[10px] font-black text-slate-500 uppercase block mb-1">å‚™è¨» (é¸å¡«)</label>
            <textarea id="ai-notes" rows="2" placeholder="åœ¨æ­¤è™•æƒ³è¦åšä»€éº¼ï¼Ÿ"></textarea>
            <label class="text-[10px] font-black text-slate-500 uppercase block mb-1">æ™¯é»ç…§ç‰‡</label>
            <input type="file" id="ai-photo" accept=".jpg" class="hidden" onchange="previewImg(this)">
            <button onclick="document.getElementById('ai-photo').click()" class="w-full py-4 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold mb-4">
                <i class="fas fa-image mr-2"></i> ä¸Šå‚³æ™¯é»ç…§ç‰‡
            </button>
            <img id="img-preview-box" class="w-full h-40 object-cover rounded-xl mb-4 hidden">
            
            <label class="text-[10px] font-black text-blue-500 uppercase block mb-1">API KEY (åƒ…ç¬¬ä¸€æ¬¡éœ€è¼¸å…¥)</label>
            <input type="password" id="user-api-key" placeholder="è²¼ä¸Š Gemini API Key...">
            
            <button id="ai-submit-btn" onclick="processSmartAdd()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-2xl flex items-center justify-center gap-3">
                <i class="fas fa-compass"></i> é–‹å§‹æ™ºæ…§è¦åŠƒè·¯å¾‘
            </button>
        </div>
    </div>

    <!-- Green Save FAB -->
    <button id="save-btn" class="hidden fixed bottom-24 right-6 bg-emerald-500 text-white w-14 h-14 rounded-full shadow-2xl z-[100] flex items-center justify-center text-2xl border-4 border-white">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒæ•¸æ“šï¼š3/18 åˆ° 3/31 å®Œæ•´è¡Œç¨‹ ---
        const defaultTripData = {
            config: { apiKey: "", startTime: "08:00" },
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "å°åŒ— â” è˜‡é»ä¸– â” å› ç‰¹æ‹‰è‚¯", weather: { temp: "5~12Â°C", rain: "10%", vis: "è‰¯å¥½", icon: "cloud-sun" }, cards: [
                    { type: "spot", name: "å°åŒ—æ©Ÿå ´ (TPE)", desc: "00:20 å‡ºç™¼ EK0387ã€‚é–‹å•Ÿä¹‹æ—…ï¼", img: "", stay: 1, visited: false },
                    { type: "transport", mode: "é£›æ©Ÿ", route: "æœæ‹œè½‰æ©Ÿ â” 12:25 æŠµ ZRH", time: "12hr+" },
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´ ZRH", desc: "è½åœ°ã€å…¥å¢ƒã€å•Ÿå‹• Swiss Passã€‚", img: "", stay: 1, visited: false },
                    { type: "transport", mode: "ç«è»Š IC8/61", route: "æ©Ÿå ´ â” ä¼¯æ© â” å› ç‰¹æ‹‰è‚¯", stops: "3ç«™/2ç«™", time: "2.5hr", map: "https://www.google.com/maps/dir/Zurich+Airport/Interlaken+Ost/" },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯ (å¾…å®š)", desc: "æ”¾è¡Œæã€æ—©ä¼‘æ¯èª¿æ•´æ™‚å·®ã€‚", img: "", stay: 12, visited: false }
                ]},
                { day: 2, date: "3/19", weekday: "THU", title: "å°‘å¥³å³°ï¼šæ­æ´²ä¹‹å·”å…¨è¦½", weather: { temp: "-8~2Â°C", rain: "5%", vis: "é«˜å±±é›²æµ·", icon: "snowflake" }, cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "æ™¨é–“å‡ºç™¼å‰å¾€æ ¼æ—å¾·ç“¦ã€‚", stay: 0.5 },
                    { type: "transport", mode: "ç«è»Š R61", route: "æ±ç«™ â” æ ¼æ—å¾·ç“¦ Terminal", time: "35åˆ†" },
                    { type: "transport", mode: "è‰¾æ ¼å¿«ç·š", route: "è½‰é‹ç«™ â” è‰¾æ ¼å†°æ²³ç«™", time: "15åˆ†" },
                    { type: "spot", name: "å°‘å¥³å³°å·”å³°å…¨è¦½", desc: "11:00-14:00 æ‹æ”ç†±é»ï¼šæ–¯èŠ¬å…‹æ–¯è§€æ™¯å°ã€é˜¿èŠå¥‡å†°å·ã€å†°åŸå¹³å°ã€‚", stay: 4 },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯ (å¾…å®š)", desc: "åŸè·¯è¿”å›é£¯åº—ä¼‘æ¯ã€‚", stay: 12 }
                ]},
                { day: 3, date: "3/20", weekday: "FRI", title: "First å€’å½± â” ç›§é”æœ¬ç´", weather: { temp: "2~10Â°C", rain: "20%", vis: "éœ§æ°£", icon: "cloud" }, cards: [
                    { type: "spot", name: "First ï¼‹ Bachalpsee å€’å½±æ¹–", desc: "æ‹æ”é›ªå±±å€’å½±ï¼Œéœ€å¥è¡Œç´„ 50 åˆ†é˜ã€‚", stay: 3 },
                    { type: "transport", mode: "ç«è»Š/å…¬è»Š", route: "Grindelwald â” Lauterbrunnen", time: "45åˆ†" },
                    { type: "spot", name: "ç›§é”æœ¬ç´ ç€‘å¸ƒè°·", desc: "æ‹ Staubbach Falls é€†å…‰èˆ‡æ‘èŠã€‚", stay: 2 },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯ (å¾…å®š)", desc: "ä¼‘æ¯ã€‚", stay: 12 }
                ]},
                { day: 4, date: "3/21", weekday: "SAT", title: "ç±³å€« â” é›ªæœ—å³° Schilthorn", weather: { temp: "0~8Â°C", rain: "0%", vis: "æ™´æœ—", icon: "sun" }, cards: [
                    { type: "spot", name: "MÃ¼rren ç±³å€«å°é®", desc: "ç„¡è»Šå°é®æ•£æ­¥ã€‚", stay: 1.5 },
                    { type: "transport", mode: "çºœè»Š", route: "MÃ¼rren â” Schilthorn", time: "20åˆ†" },
                    { type: "spot", name: "é›ªæœ—å³° Schilthorn", desc: "çœºæœ›å°‘å¥³ä¸‰å³°æœ€ä½³é»ã€‚", stay: 3 },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯ (å¾…å®š)", desc: "è¿”å›é£¯åº—ã€‚", stay: 12 }
                ]},
                { day: 5, date: "3/22", weekday: "SUN", title: "åœ–æ©æ¹– â” æ–½çš®èŒ¨åŸå ¡", weather: { temp: "5~14Â°C", rain: "15%", vis: "è‰¯å¥½", icon: "cloud-sun" }, cards: [
                    { type: "spot", name: "åœ–æ©æ¹– Lake Thun", desc: "æ¹–å²¸æ•£æ­¥æ‹é›ªå±±å€’å½±ã€‚", stay: 2 },
                    { type: "spot", name: "æ–½çš®èŒ¨åŸå ¡ Spiez", desc: "çµ•ç¾æ¹–ç•”åŸå ¡ã€‚", stay: 2 },
                    { type: "spot", name: "ä½å®¿ï¼šå› ç‰¹æ‹‰è‚¯æˆ– Spiez", desc: "æœ€å¾Œä¸€æ™šä¼¯æ©é«˜åœ°ã€‚", stay: 12 }
                ]},
                { day: 6, date: "3/23", weekday: "MON", title: "å› ç‰¹æ‹‰è‚¯ â” ç±³è˜­ (ç§»å‹•æ—¥)", weather: { temp: "10~18Â°C", rain: "0%", vis: "è‰¯å¥½", icon: "sun" }, cards: [
                    { type: "transport", mode: "ç«è»Š", route: "Interlaken â” Spiez", time: "20åˆ†" },
                    { type: "transport", mode: "ç«è»Š EC", route: "Spiez â” ç±³è˜­ä¸­å¤®è»Šç«™", time: "4hr", map: "https://www.google.com/maps/dir/Spiez/Milan+Centrale/" },
                    { type: "spot", name: "ä½å®¿ï¼šç±³è˜­", desc: "ä¸‹åˆè‡ªç”±æ´»å‹•ã€é€›è¡—åƒé£¯ã€‚", stay: 6 }
                ]},
                { day: 7, date: "3/24", weekday: "TUE", title: "ç±³è˜­å¸‚å€æ·±åº¦éŠ", weather: { temp: "12~20Â°C", rain: "0%", vis: "è‰¯å¥½", icon: "sun" }, cards: [
                    { type: "spot", name: "ç±³è˜­ä¸»æ•™åº§å ‚ Duomo", desc: "ä¸‹åˆå»£å ´å…‰ç·šæœ€å¥½ã€‚", stay: 3 },
                    { type: "spot", name: "åŸƒé¦¬åŠªåŸƒèŠäºŒä¸–æ‹±å»Š", desc: "ç²¾å“èˆ‡å»ºç¯‰ä¹‹ç¾ã€‚", stay: 1.5 },
                    { type: "spot", name: "Mercato Centrale Milano", desc: "æ™šé¤ç¾é£Ÿå¤§åŒ¯é›†ã€‚", stay: 2 },
                    { type: "spot", name: "ä½å®¿ï¼šç±³è˜­", stay: 12 }
                ]},
                { day: 8, date: "3/25", weekday: "WED", title: "ç±³è˜­ â” ç­–é¦¬ç‰¹ (åˆè¦‹)", weather: { temp: "2~10Â°C", rain: "0%", vis: "æ¸…æ™°", icon: "sun" }, cards: [
                    { type: "spot", name: "Naviglio Grande é‹æ²³å€", desc: "ä¸Šåˆæ¼«æ­¥æ‹ç…§ã€‚", stay: 2.5 },
                    { type: "transport", mode: "ç«è»Š", route: "Milan â” Visp â” Zermatt", time: "3.5hr" },
                    { type: "spot", name: "ç­–é¦¬ç‰¹ Matterhorn Viewpoint", desc: "å‚æ™šåˆè¦‹é¦¬ç‰¹æ´ªå³°ï¼Œæ‹æ—¥è½è—èª¿ã€‚", stay: 2 },
                    { type: "spot", name: "ä½å®¿ï¼šç­–é¦¬ç‰¹", stay: 12 }
                ]},
                { day: 9, date: "3/26", weekday: "THU", title: "ç­–é¦¬ç‰¹å°é®å…¨æ–¹ä½æ‹æ”", weather: { temp: "0~9Â°C", rain: "0%", vis: "æ¥µä½³", icon: "sun" }, cards: [
                    { type: "spot", name: "KirchbrÃ¼cke æ©‹ (æ—¥å‡º)", desc: "æ‹æ”é»ƒé‡‘é¦¬ç‰¹æ´ªå³°ã€‚", stay: 1 },
                    { type: "spot", name: "Hinterdorf è€æ‘", desc: "æ‹æ”å¤è€ç“¦èŠæœ¨å±‹ã€‚", stay: 2 },
                    { type: "spot", name: "Matterhorn Viewpoint (æ˜Ÿç©º)", desc: "å¤œæ™šæ‹æ”é•·æ›æ˜Ÿç©ºé¦¬å³°ã€‚", stay: 2 },
                    { type: "spot", name: "ä½å®¿ï¼šç­–é¦¬ç‰¹", stay: 12 }
                ]},
                { day: 10, date: "3/27", weekday: "FRI", title: "Gornergrat â” å€’å½±æ¹–", weather: { temp: "-5~5Â°C", rain: "0%", vis: "æ¸…æ™°", icon: "sun" }, cards: [
                    { type: "transport", mode: "ç™»å±±ç«è»Š", route: "Zermatt â” Gornergrat", time: "35åˆ†" },
                    { type: "spot", name: "Riffelsee å€’å½±æ¹–", desc: "çµ•ä½³å€’å½±ä½ç½®ï¼Œå¥è¡Œä¸‹å¡ 15 åˆ†ã€‚", stay: 3 },
                    { type: "spot", name: "ä½å®¿ï¼šç­–é¦¬ç‰¹", stay: 12 }
                ]},
                { day: 11, date: "3/28", weekday: "SAT", title: "Sunnegga äº”æ¹–å¥è¡Œ", weather: { temp: "2~10Â°C", rain: "5%", vis: "è‰¯å¥½", icon: "cloud-sun" }, cards: [
                    { type: "transport", mode: "åœ°åº•çºœè»Š", route: "Zermatt â” Sunnegga", time: "5åˆ†" },
                    { type: "spot", name: "è—æ¹–ç«™ Blauherd", desc: "è¼•é¬†ä¸‹å¡å¥è¡Œè‡³ Findelnã€‚", stay: 4 },
                    { type: "spot", name: "ä½å®¿ï¼šç­–é¦¬ç‰¹", stay: 12 }
                ]},
                { day: 12, date: "3/29", weekday: "SUN", title: "ç­–é¦¬ç‰¹å½ˆæ€§å‚™ç”¨æ—¥", weather: { temp: "3~11Â°C", rain: "0%", vis: "è‰¯å¥½", icon: "sun" }, cards: [
                    { type: "spot", name: "è£œæ‹ / å’–å•¡å»³ä¼‘æ¯", desc: "éš¨èˆˆäº«å—æ™‚å…‰ã€‚", stay: 8 },
                    { type: "spot", name: "ä½å®¿ï¼šç­–é¦¬ç‰¹", stay: 12 }
                ]},
                { day: 13, date: "3/30", weekday: "MON", title: "ç­–é¦¬ç‰¹ â” è˜‡é»ä¸– (è¿”ç¨‹)", weather: { temp: "6~14Â°C", rain: "30%", vis: "ä¸­ç­‰", icon: "cloud-rain" }, cards: [
                    { type: "transport", mode: "ç«è»Š", route: "Zermatt â” Visp â” Zurich Airport", time: "4hr" },
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´ / è³¦æ­¸", desc: "ä¸‹åˆèˆªç­æ™‚é–“å……è£•ã€‚", stay: 3 }
                ]},
                { day: 14, date: "3/31", weekday: "TUE", title: "å¹³å®‰æŠµé”å°ç£", weather: { temp: "20~25Â°C", icon: "home" }, cards: [
                    { type: "spot", name: "å°ç£æ¡ƒåœ’æ©Ÿå ´", desc: "åœ“æ»¿çµæŸæ—…ç¨‹ã€‚", stay: 1 }
                ]}
            ],
            expenses: { user1: [], user2: [] },
            checklist: { custom: [] }
        };

        const fixedChecklist = ["è­·ç…§", "ä¿¡ç”¨å¡", "ç¾é‡‘", "æ‰‹æ©Ÿ", "è¡Œå‹•é›»æº", "å¸¸å‚™è—¥", "è¡›ç”Ÿç´™/æ¿•ç´™å·¾"];
        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let uploadedImgB64 = "";

        // --- åˆå§‹åŒ–èˆ‡ Firebase ç›£è½ ---
        const init = () => {
            if (window.db) {
                const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docRef, (snapshot) => {
                    if (snapshot.exists()) localData = snapshot.data();
                    renderAll();
                }, (err) => { renderAll(); });
            } else { renderAll(); }
        };

        window.addEventListener('auth-ready', init);
        setTimeout(() => { if(!window.userId) renderAll(); }, 2000);

        // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸ ---
        const renderAll = () => {
            renderDayNav();
            renderItinerary();
            renderOverview();
            renderExpenses();
            renderPrep();
            updateWeather();
        };

        const renderDayNav = () => {
            const nav = document.getElementById('day-navbar');
            nav.innerHTML = '';
            localData.days.forEach(d => {
                const btn = document.createElement('button');
                btn.className = `day-tab ${d.day === currentDay ? 'active' : ''}`;
                btn.onclick = () => { currentDay = d.day; renderAll(); };
                btn.innerHTML = `<span class="text-[9px] uppercase font-black opacity-60">Day</span><span class="text-xl serif italic font-black">${d.day}</span><span class="text-[10px] font-bold">${d.date}</span>`;
                nav.appendChild(btn);
            });
        };

        const renderItinerary = () => {
            const dayData = localData.days.find(d => d.day === currentDay);
            const list = document.getElementById('itinerary-list');
            document.getElementById('departure-time-input').value = dayData.startTime || localData.config.startTime;
            list.innerHTML = '';

            let hasFoundCurrentMarker = false;
            dayData.cards.forEach((card, idx) => {
                if (card.type === 'spot') {
                    const isCurrent = !card.visited && !hasFoundCurrentMarker;
                    if (isCurrent) hasFoundCurrentMarker = true;
                    
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <div class="timeline-line ${card.visited ? 'active' : ''}"></div>
                        <div class="timeline-dot ${card.visited ? 'visited' : ''}"></div>
                        ${isCurrent ? '<i class="fas fa-running person-marker"></i>' : ''}
                        <div class="spot-card ${card.visited ? 'visited' : ''}" onclick="toggleExpand(${idx})">
                            ${isEditMode ? `<button class="btn-delete" onclick="event.stopPropagation(); deleteCard(${idx})"><i class="fas fa-times"></i></button>` : ''}
                            <div class="flex justify-between items-center">
                                <h3 class="spot-title font-bold text-lg tracking-tight">${card.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black text-slate-400 bg-slate-50 px-2 py-1 rounded-md">STAY ${card.stay}H</span>
                                    <button onclick="event.stopPropagation(); toggleVisited(${idx})" class="w-8 h-8 rounded-full ${card.visited ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-300'}"><i class="fas fa-check"></i></button>
                                </div>
                            </div>
                            <div id="details-${idx}" class="details">
                                ${card.img ? `<img src="${card.img}" class="w-full h-44 object-cover rounded-xl mb-3 shadow-inner">` : ''}
                                <p class="text-sm leading-relaxed text-slate-500 font-medium">${card.desc || 'å°šç„¡å‚™è¨»ã€‚'}</p>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <div class="timeline-line"></div>
                        <div class="nav-link-card">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-bold text-blue-600"><i class="fas fa-route mr-2"></i>${card.mode}: ${card.route}</div>
                                <span class="text-[10px] font-black text-blue-400 uppercase">${card.time}</span>
                            </div>
                            ${card.map ? `<a href="${card.map}" target="_blank" class="mt-3 block text-center bg-blue-600 text-white text-[11px] font-black py-2 rounded-lg"><i class="fas fa-location-arrow mr-1"></i> GOOGLE MAPS å°èˆª</a>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
            updateTotalTime(dayData);
        };

        const renderOverview = () => {
            const list = document.getElementById('overview-map-list');
            const dayData = localData.days.find(d => d.day === currentDay);
            list.innerHTML = '';
            dayData.cards.filter(c => c.type === 'spot').forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border-l-8 border-slate-800';
                div.innerHTML = `<span class="text-2xl font-black italic opacity-20">${i+1}</span><div class="font-bold text-slate-700">${c.name}</div>`;
                list.appendChild(div);
            });
        };

        const renderExpenses = () => {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let total = 0;
            ["user1", "user2"].forEach(u => {
                const uExpenses = localData.expenses[u] || [];
                const uTotal = uExpenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
                total += uTotal;
                
                const section = document.createElement('div');
                section.className = u === 'user1' ? 'mb-6' : '';
                section.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-black uppercase text-slate-400">${u === 'user1' ? 'æ‚¨çš„ç´€éŒ„' : 'æ—…ä¼´çš„ç´€éŒ„'}</span>
                        <span class="text-sm font-bold text-slate-700">CHF ${uTotal.toFixed(2)}</span>
                    </div>
                `;
                uExpenses.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'expense-row';
                    row.innerHTML = `<div class="flex-1 font-bold text-slate-700">${item.name || u}</div><div class="font-black text-slate-800">CHF ${item.amount}</div>`;
                    section.appendChild(row);
                });
                list.appendChild(section);
            });
            document.getElementById('grand-total-expense').innerText = `CHF ${total.toFixed(2)}`;
        };

        const renderPrep = () => {
            const fixed = document.getElementById('prep-list-fixed');
            const custom = document.getElementById('prep-list-custom');
            fixed.innerHTML = ''; custom.innerHTML = '';
            
            fixedChecklist.forEach(item => {
                const isDone = (localData.checklist[item] === true);
                const div = document.createElement('div');
                div.className = `check-item ${isDone ? 'done' : ''}`;
                div.onclick = () => { localData.checklist[item] = !isDone; renderPrep(); document.getElementById('save-btn').classList.remove('hidden'); };
                div.innerHTML = `<i class="fas ${isDone ? 'fa-check-circle text-orange-500' : 'fa-circle text-slate-200'} text-xl mr-4"></i><span class="font-bold text-slate-700">${item}</span>`;
                fixed.appendChild(div);
            });

            // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            const allFixed = fixedChecklist.every(k => localData.checklist[k] === true);
            document.getElementById('prep-congrats').classList.toggle('hidden', !allFixed);
        };

        const updateWeather = () => {
            const w = localData.days.find(d => d.day === currentDay).weather || {};
            document.getElementById('header-weather').innerHTML = `
                <i class="fas fa-${w.icon || 'sun'} text-orange-400 text-lg"></i>
                <span>${w.temp || 'N/A'}</span>
                <span class="opacity-40">|</span>
                <span>é›¨ç‡ ${w.rain || '0%'}</span>
                <span class="opacity-40">|</span>
                <span>èƒ½è¦‹åº¦ ${w.vis || '--'}</span>
            `;
        };

        // --- åŠŸèƒ½é‚è¼¯ ---
        window.switchPage = (p) => {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.querySelector(`[onclick="switchPage('${p}')"]`).classList.add('active');
        };

        window.toggleExpand = (idx) => {
            const el = document.getElementById(`details-${idx}`);
            el.classList.toggle('open');
        };

        window.toggleVisited = (idx) => {
            const day = localData.days.find(d => d.day === currentDay);
            day.cards[idx].visited = !day.cards[idx].visited;
            renderAll();
            document.getElementById('save-btn').classList.remove('hidden');
        };

        window.addExpense = () => {
            const name = document.getElementById('exp-name').value;
            const amt = document.getElementById('exp-amount').value;
            const u = document.getElementById('exp-user').value;
            if(!amt) return;
            if(!localData.expenses[u]) localData.expenses[u] = [];
            localData.expenses[u].push({ name, amount: parseFloat(amt).toFixed(2), date: new Date().toLocaleDateString() });
            document.getElementById('exp-name').value = '';
            document.getElementById('exp-amount').value = '';
            renderExpenses();
            document.getElementById('save-btn').classList.remove('hidden');
        };

        window.openAIModal = () => document.getElementById('ai-modal').style.display = 'flex';
        window.closeAIModal = () => document.getElementById('ai-modal').style.display = 'none';

        window.previewImg = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImgB64 = e.target.result;
                    document.getElementById('img-preview-box').src = uploadedImgB64;
                    document.getElementById('img-preview-box').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.processSmartAdd = async () => {
            const link = document.getElementById('ai-link').value;
            const stay = document.getElementById('ai-stay').value;
            const note = document.getElementById('ai-notes').value;
            const key = document.getElementById('user-api-key').value || localData.config.apiKey;
            if(!link) return;
            
            const btn = document.getElementById('ai-submit-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i> æ­£åœ¨é‡æ–°æ’ç¨‹è·¯å¾‘...';
            
            const dayData = localData.days.find(d => d.day === currentDay);
            const currentCards = JSON.stringify(dayData.cards);

            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°éŠã€‚è«‹æ ¹æ“šæ–°æ™¯é» (Map: ${link}, åœç•™: ${stay}hr, å‚™è¨»: ${note})
            èˆ‡ç›®å‰è¡Œç¨‹é †åº (${currentCards})ï¼Œæ±ºå®šæœ€é †è·¯çš„æ’å…¥ä½ç½®ä¸¦é‡æ–°è¼¸å‡ºè©²å¤©å®Œæ•´çš„ cards é™£åˆ— JSONã€‚
            å¿…é ˆåŒ…å«å¿…è¦çš„ type: transport å¡ç‰‡ã€‚
            JSON æ ¼å¼è¦ç¯„ï¼š[{"type":"spot/transport", "name":"...", "desc":"...", "stay":1.5, "visited":false, "mode":"ç«è»Š", "route":"...", "time":"...", "map":"å°èˆªé€£çµ"}]`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" }})
                });
                const result = await res.json();
                const newCards = JSON.parse(result.candidates[0].content.parts[0].text);
                
                // æ‰¾åˆ°æ–°æ™¯é»å¡«å…¥åœ–ç‰‡
                newCards.forEach(c => { if(c.type === 'spot' && !c.img && uploadedImgB64) c.img = uploadedImgB64; });
                
                dayData.cards = newCards;
                localData.config.apiKey = key;
                document.getElementById('save-btn').classList.remove('hidden');
                closeAIModal(); renderAll();
            } catch (e) { alert("è¦åŠƒå¤±æ•—ï¼š" + e.message); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i> é–‹å§‹æ™ºæ…§è¦åŠƒè·¯å¾‘'; }
        };

        const updateTotalTime = (day) => {
            let totalMin = 0;
            day.cards.forEach(c => {
                if(c.type === 'transport' && c.time) {
                    const match = c.time.match(/(\d+\.?\d*)/);
                    if(match) totalMin += c.time.includes('hr') ? match[0] * 60 : parseInt(match[0]);
                }
            });
            document.getElementById('total-travel-time').innerText = `ç¸½è·¯ç¨‹ç´„: ${Math.floor(totalMin/60)}H ${totalMin%60}M`;
        };

        document.getElementById('edit-mode-toggle').onclick = () => {
            isEditMode = !isEditMode;
            document.getElementById('edit-mode-toggle').classList.toggle('text-emerald-500');
            document.getElementById('add-smart-btn').classList.toggle('hidden');
            renderAll();
        };

        document.getElementById('add-smart-btn').onclick = openAIModal;

        document.getElementById('save-btn').onclick = async () => {
            if(!window.db) return;
            await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master'), localData);
            document.getElementById('save-btn').classList.add('hidden');
            alert("åŒæ­¥é›²ç«¯æˆåŠŸï¼");
        };
    </script>
</body>
</html>
