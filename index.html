<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swiss & Milan 2026 | AI 數位旅遊書</title>
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) { console.error("Firebase Config Error", e); }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else { await signInAnonymously(window.auth); }
                    window.dispatchEvent(new CustomEvent('firebase-ready'));
                } catch (e) { window.dispatchEvent(new CustomEvent('firebase-error')); }
            };
            initAuth();
        } else { setTimeout(() => window.dispatchEvent(new CustomEvent('firebase-error')), 500); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@600&display=swap');
        :root { --bg-base: #FDFCFB; --accent-transport: #5B84B1; --accent-spot: #D4A373; --accent-hotel: #8E7B6D; }
        body { background-color: var(--bg-base); color: #3D3D3D; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; font-size: 16px; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card { background: white; border-radius: 24px; width: 100%; margin-bottom: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(230, 225, 218, 0.6); position: relative; }
        .transport-card { background: #F8FAFC; border: 1.5px dashed var(--accent-transport); }
        .spot-card { border-bottom: 5px solid var(--accent-spot); }
        .hotel-card { border-left: 8px solid var(--accent-hotel); }
        .arrow-divider { display: flex; justify-content: center; align-items: center; height: 40px; color: #E2E8F0; font-size: 1.5rem; }
        .day-btn { flex: 0 0 auto; width: 70px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; transition: all 0.3s; background: transparent; }
        .day-btn.active { background: white; box-shadow: 0 6px 15px rgba(0,0,0,0.08); color: var(--accent-transport); transform: translateY(-3px); border: 1px solid #E2E8F0; }
        .step-list-item { position: relative; padding-left: 32px; border-left: 2px solid #CBD5E1; margin-left: 10px; margin-bottom: 16px; }
        .step-list-item::before { content: ''; position: absolute; left: -6px; top: 8px; width: 10px; height: 10px; background: var(--accent-transport); border-radius: 50%; }
        .nav-link-btn { color: var(--accent-transport); font-size: 0.9rem; font-weight: 700; background: #EFF6FF; padding: 4px 12px; border-radius: 10px; }
        .ai-loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-add { background: #F1F5F9; color: #64748B; width: 100%; padding: 12px; border-radius: 16px; border: 2px dashed #CBD5E1; font-weight: bold; margin: 10px 0; }
        input, textarea, select { background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 10px; width: 100%; font-size: 15px; margin-bottom: 10px; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-24">

    <header class="sticky top-0 z-50 bg-[#FDFCFB]/95 backdrop-blur-md pt-8 pb-4 shadow-sm">
        <div class="px-5 mb-5 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extralight tracking-widest serif italic text-slate-700">The Archive.</h1>
                <p class="text-[12px] uppercase tracking-[0.3em] text-slate-400 mt-1 font-bold">2026 AI TRAVEL ASSISTANT</p>
            </div>
            <div class="flex gap-2">
                <button id="edit-toggle" class="bg-slate-100 p-2 rounded-full text-slate-400 hover:text-emerald-500 transition">
                    <i class="fas fa-edit text-lg"></i>
                </button>
            </div>
        </div>
        <div class="flex overflow-x-auto no-scrollbar gap-3 px-5 pb-2" id="date-navbar"></div>
    </header>

    <main class="px-5 mt-6" id="itinerary-content">
        <div class="flex flex-col justify-center items-center py-32 text-slate-300">
            <i class="fas fa-circle-notch animate-spin text-3xl mb-4"></i>
            <p>同步雲端行程中...</p>
        </div>
    </main>

    <!-- AI Add Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-[32px] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-2 serif">AI 導遊規劃</h3>
            <p class="text-slate-400 text-sm mb-6">輸入目的地，系統將自動評估路線與交通。</p>
            
            <label class="text-xs font-bold text-slate-400 uppercase">目的地名稱</label>
            <input type="text" id="ai-dest" placeholder="例如：格林德瓦、10 Corso Como...">
            
            <label class="text-xs font-bold text-slate-400 uppercase">行程細節/備註 (選填)</label>
            <textarea id="ai-notes" rows="3" placeholder="想在此做什麼？例如：拍照、喝咖啡..."></textarea>

            <label class="text-xs font-bold text-slate-400 uppercase">參考照片網址 (選填)</label>
            <input type="text" id="ai-img" placeholder="https://...">

            <div class="flex gap-3 mt-6">
                <button onclick="closeAIModal()" class="flex-1 bg-slate-100 py-4 rounded-2xl font-bold text-slate-500">取消</button>
                <button id="ai-submit-btn" onclick="processAIPlanning()" class="flex-2 bg-emerald-500 py-4 px-8 rounded-2xl font-bold text-white shadow-lg shadow-emerald-200">
                    <i class="fas fa-magic mr-2"></i>開始規劃
                </button>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <button id="save-btn" class="hidden fixed bottom-8 right-6 bg-emerald-500 text-white w-14 h-14 rounded-full shadow-2xl z-[100] flex items-center justify-center text-2xl">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Gemini API 使用規則
        const apiKey = ""; // 執行環境將提供 Key
        const retryWithBackoff = async (fn, retries = 5, delay = 1000) => {
            try { return await fn(); }
            catch (e) {
                if (retries === 0) throw e;
                await new Promise(r => setTimeout(r, delay));
                return retryWithBackoff(fn, retries - 1, delay * 2);
            }
        };

        const defaultTripData = {
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "入境蘇黎世 ➔ 因特拉肯", cards: [
                    { type: "hotel", name: "蘇黎世機場 (ZRH)", desc: "12:25 落地。啟動 Swiss Pass。", img: "https://images.unsplash.com/photo-1542296332-2e4473faf563" },
                    { type: "transport", name: "鐵路路程", img: "https://images.unsplash.com/photo-1527668752968-14dc70a27c95", steps: [{mode: "火車", route: "ZRH ➔ Interlaken", time: "2h"}], detail: "建議搭乘景觀段。" },
                    { type: "spot", name: "因特拉肯東站", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", desc: "入飯店放行李。晚上草地散步。" }
                ]}
            ]
        };

        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let insertIndex = -1;

        const getTransportIcon = (mode) => {
            const m = mode.toLowerCase();
            if (m.includes('火車') || m.includes('train')) return '<i class="fas fa-train mr-3 text-blue-500"></i>';
            if (m.includes('纜車') || m.includes('cable') || m.includes('快線')) return '<i class="fas fa-cable-car mr-3 text-purple-500"></i>';
            if (m.includes('步行') || m.includes('走') || m.includes('健行')) return '<i class="fas fa-walking mr-3 text-emerald-500"></i>';
            if (m.includes('飛機') || m.includes('落地')) return '<i class="fas fa-plane mr-3 text-slate-400"></i>';
            if (m.includes('地鐵')) return '<i class="fas fa-subway mr-3 text-red-500"></i>';
            return '<i class="fas fa-chevron-right mr-3 text-slate-300"></i>';
        };

        const renderNavBar = () => {
            const navbar = document.getElementById('date-navbar');
            navbar.innerHTML = '';
            localData.days.sort((a,b) => a.day - b.day).forEach(item => {
                const btn = document.createElement('button');
                btn.className = `day-btn ${item.day === currentDay ? 'active' : ''}`;
                btn.onclick = () => { currentDay = item.day; renderNavBar(); renderContent(); window.scrollTo(0,0); };
                btn.innerHTML = `<span class="text-[11px] font-black text-slate-400 opacity-60 uppercase">Day</span>
                                 <span class="text-3xl font-serif italic leading-none my-1">${item.day}</span>
                                 <span class="text-[12px] font-bold opacity-80">${item.date}</span>`;
                navbar.appendChild(btn);
            });
        };

        const renderContent = () => {
            const data = localData.days.find(d => d.day === currentDay);
            const container = document.getElementById('itinerary-content');
            if(!data) { container.innerHTML = `<p class="py-20 text-center text-slate-400">無詳細內容。</p>`; return; }

            let html = `
                <div class="mb-8 fade-in">
                    <p class="text-[13px] font-black text-slate-400 tracking-widest uppercase mb-1 italic">March ${data.date} (${data.weekday})</p>
                    <h2 class="text-3xl font-serif italic text-slate-700 leading-tight">${data.title}</h2>
                </div>
            `;

            data.cards.forEach((card, idx) => {
                if (idx > 0) html += `<div class="arrow-divider"><i class="fas fa-chevron-down text-slate-200"></i></div>`;
                
                let cardHtml = '';
                if (card.type === 'hotel') {
                    cardHtml = `<div class="card hotel-card shadow-lg p-6">
                            <div class="h-36 bg-slate-100 bg-cover bg-center rounded-2xl mb-4" style="background-image: url('${card.img}')"></div>
                            <div class="flex items-center gap-2 mb-3 text-xs font-black text-slate-400 uppercase tracking-widest"><i class="fas fa-house-chimney text-orange-400"></i>Base</div>
                            <h3 class="text-lg font-bold text-slate-700">${card.name}</h3>
                            <p class="text-[14px] text-slate-400 mt-2 italic font-medium">${card.desc}</p>
                        </div>`;
                } else if (card.type === 'transport') {
                    cardHtml = `<div class="card transport-card shadow-sm p-6">
                            <div class="flex items-center gap-2 mb-4 text-xs font-black text-slate-500 uppercase tracking-widest"><i class="fas fa-route text-blue-500"></i>Route Log</div>
                            <div class="space-y-4 mb-4">
                                ${card.steps.map(s => `
                                    <div class="step-list-item">
                                        <p class="text-[15px] font-bold text-slate-700 flex items-center">${getTransportIcon(s.mode)}${s.mode}: ${s.route}</p>
                                        <p class="text-[12px] text-slate-400 font-black ml-10">⏱️ ${s.time}</p>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="bg-blue-50/70 p-4 rounded-xl text-blue-700 italic font-bold text-[14px] border border-blue-100">${card.detail}</div>
                        </div>`;
                } else if (card.type === 'spot') {
                    cardHtml = `<div class="card spot-card shadow-xl p-6">
                            <div class="h-48 bg-slate-100 bg-cover bg-center rounded-2xl mb-4" style="background-image: url('${card.img}')"></div>
                            <div class="flex items-center gap-2 mb-3 text-xs font-black text-slate-400 uppercase tracking-widest"><i class="fas fa-camera-retro text-orange-400"></i>Spotlight</div>
                            <h3 class="text-xl font-bold text-slate-700 serif">${card.name}</h3>
                            <p class="text-[14px] text-slate-500 mt-3 leading-relaxed font-medium">${card.desc}</p>
                        </div>`;
                }

                html += cardHtml;
                
                // 編輯模式下的新增按鈕
                if (isEditMode) {
                    html += `<button onclick="openAIModal(${idx})" class="btn-add"><i class="fas fa-plus-circle mr-2"></i>在此之後新增 AI 規劃點</button>`;
                }
            });
            container.innerHTML = html;
        };

        // AI 規劃邏輯
        window.openAIModal = (idx) => {
            insertIndex = idx;
            document.getElementById('ai-modal').classList.remove('hidden');
        };

        window.closeAIModal = () => {
            document.getElementById('ai-modal').classList.add('hidden');
        };

        window.processAIPlanning = async () => {
            const dest = document.getElementById('ai-dest').value;
            const notes = document.getElementById('ai-notes').value;
            const imgUrl = document.getElementById('ai-img').value || "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1";
            
            if (!dest) { alert("請輸入目的地"); return; }
            
            const btn = document.getElementById('ai-submit-btn');
            btn.disabled = true;
            btn.classList.add('ai-loading');
            btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>AI 導遊規劃中...';

            const currentDayObj = localData.days.find(d => d.day === currentDay);
            const prevSpot = currentDayObj.cards[insertIndex].name;

            const systemPrompt = `你是一位專業的瑞士旅遊導遊。
            請根據使用者想去的新景點，規劃從「${prevSpot}」出發的交通與描述。
            請務必回傳 JSON 格式，結構如下：
            {
                "transport": {
                    "steps": [{"mode": "交通工具名稱", "route": "路線描述", "time": "預估時間"}],
                    "detail": "一段詳細的搭乘建議與轉乘備註"
                },
                "spot": {
                    "name": "地點名稱",
                    "desc": "一段吸引人的景點描述，包含攝影熱門點建議與提醒"
                }
            }
            請確保交通工具包含 火車、纜車 或 步行。`;

            const userPrompt = `新增景點：${dest}。使用者備註：${notes}`;

            try {
                const response = await retryWithBackoff(() => fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                }));
                const result = await response.json();
                const aiResult = JSON.parse(result.candidates[0].content.parts[0].text);

                // 構建新卡片
                const newTransportCard = {
                    type: "transport",
                    name: `前往 ${aiResult.spot.name}`,
                    img: "https://images.unsplash.com/photo-1531366930491-81529969ff3c",
                    steps: aiResult.transport.steps,
                    detail: aiResult.transport.detail
                };

                const newSpotCard = {
                    type: "spot",
                    name: aiResult.spot.name,
                    desc: aiResult.spot.desc,
                    img: imgUrl
                };

                // 插入數據
                currentDayObj.cards.splice(insertIndex + 1, 0, newTransportCard, newSpotCard);
                
                document.getElementById('save-btn').classList.remove('hidden');
                closeAIModal();
                renderContent();
            } catch (e) {
                console.error(e);
                alert("AI 規劃失敗，請檢查網路後重試。");
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-loading');
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>開始規劃';
            }
        };

        document.getElementById('edit-toggle').onclick = () => {
            isEditMode = !isEditMode;
            document.getElementById('edit-toggle').classList.toggle('text-emerald-500');
            renderContent();
        };

        document.getElementById('save-btn').onclick = async () => {
            if(!window.db) { alert("尚未設定雲端儲存。"); return; }
            try {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                await setDoc(docPath, localData);
                document.getElementById('save-btn').classList.add('hidden');
                isEditMode = false;
                renderContent();
            } catch (e) { console.error(e); }
        };

        const loadData = () => {
            if (window.db) {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docPath, (doc) => {
                    if (doc.exists()) { localData = doc.data(); }
                    renderNavBar(); renderContent();
                }, (err) => { renderNavBar(); renderContent(); });
            } else { renderNavBar(); renderContent(); }
        };

        window.addEventListener('firebase-ready', loadData);
        window.addEventListener('firebase-error', loadData);
        setTimeout(() => { if(document.getElementById('itinerary-content').innerText.includes('同步')) loadData(); }, 2000);
    </script>
</body>
</html>
