<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swiss & Milan 2026 | å°èˆªç´šæ•¸ä½è¡Œç¨‹</title>
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) { console.error("Firebase Config Error", e); }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else { await signInAnonymously(window.auth); }
                    window.dispatchEvent(new CustomEvent('firebase-ready'));
                } catch (e) { window.dispatchEvent(new CustomEvent('firebase-error')); }
            };
            initAuth();
        } else { setTimeout(() => window.dispatchEvent(new CustomEvent('firebase-error')), 500); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600&display=swap');
        :root { --bg-base: #F0F2F5; --accent-transport: #3B82F6; --accent-spot: #1E293B; --accent-main: #EF4444; }
        body { background-color: var(--bg-base); color: #1E293B; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ™¯é»å¡ç‰‡ï¼šå¯¦é«”ç™½è‰² */
        .spot-card { background: white; border-radius: 24px; width: 100%; margin: 12px 0; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.8); position: relative; }
        .spot-img { width: 100%; height: 220px; object-fit: cover; border-radius: 16px; margin-bottom: 16px; }
        
        /* äº¤é€šå°èˆªå¡ç‰‡ï¼šæ·¡è—è‰²èƒŒæ™¯ï¼Œæ­¥é€²å¼è¨­è¨ˆ */
        .nav-log-card { background: #EBF3FF; border-radius: 24px; padding: 20px; border: 1px solid #BFDBFE; margin: 8px 0; position: relative; }
        .nav-step { position: relative; padding-left: 28px; margin-bottom: 16px; }
        .nav-step:last-child { margin-bottom: 0; }
        .nav-step::before { content: ''; position: absolute; left: 6px; top: 8px; width: 2px; height: calc(100% + 8px); background: #93C5FD; }
        .nav-step:last-child::before { display: none; }
        .nav-dot { position: absolute; left: 0; top: 4px; width: 14px; height: 14px; background: white; border: 3px solid var(--accent-transport); border-radius: 50%; z-index: 2; }
        
        .day-btn { flex: 0 0 auto; width: 70px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; transition: all 0.3s; background: white; color: #64748B; border: 1px solid #E2E8F0; }
        .day-btn.active { background: #1E293B; color: white; border-color: #1E293B; transform: translateY(-3px); box-shadow: 0 10px 15px rgba(30, 41, 59, 0.2); }
        
        input, textarea, select { background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 14px; width: 100%; font-size: 14px; margin-bottom: 10px; }
        .btn-delete { background: #fee2e2; color: #ef4444; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 12px; right: 12px; z-index: 20; }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 16px; }
        .modal-content { background: white; width: 100%; border-radius: 40px; padding: 32px; max-height: 92vh; overflow-y: auto; }
        .smart-add-btn { background: #10b981; color: white; width: 100%; padding: 18px; border-radius: 22px; font-weight: bold; margin-bottom: 24px; box-shadow: 0 8px 16px rgba(16, 185, 129, 0.2); }
        .transport-icon-box { background: white; padding: 8px; border-radius: 10px; display: inline-flex; margin-right: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-28">

    <header class="sticky top-0 z-50 bg-[#F0F2F5]/90 backdrop-blur-md pt-8 pb-4">
        <div class="px-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black serif text-slate-800 tracking-tighter italic">Archive 2026.</h1>
                <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400 font-black mt-1">Swiss & Milan Photography</p>
            </div>
            <button id="edit-toggle" class="bg-white shadow-sm p-3 rounded-2xl text-slate-400 hover:text-red-500 transition">
                <i class="fas fa-layer-group text-lg"></i>
            </button>
        </div>
        <div class="flex overflow-x-auto no-scrollbar gap-3 px-6 pb-2" id="date-navbar"></div>
    </header>

    <main class="px-6 mt-2" id="itinerary-content">
        <!-- å…§å®¹ç”± JS ç”Ÿæˆ -->
    </main>

    <!-- AI æ™ºæ…§å°èˆªè¦åŠƒè¦–çª— -->
    <div id="ai-modal" class="modal-bg">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800">AI å°èˆªåŠ é»</h3>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Smart Route Integration</p>
                </div>
                <button onclick="closeAIModal()" class="bg-slate-100 p-2 rounded-full text-slate-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">Google Map ç¶²å€ (å¿…å¡«)</label>
            <input type="text" id="ai-link" placeholder="è²¼ä¸Šåœ°åœ–åˆ†äº«é€£çµ...">

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">åŠ å…¥æ—¥æœŸ</label>
                    <select id="ai-day-select"></select>
                </div>
                <div>
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">é è¨ˆåœç•™ (H)</label>
                    <input type="number" id="ai-duration" value="2" step="0.5">
                </div>
            </div>

            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">è¡Œç¨‹å‚™è¨» (é¸å¡«)</label>
            <textarea id="ai-notes" rows="2" placeholder="ä¾‹å¦‚ï¼šæ­¤è™•ç‚ºæ‹æ”é¦¬ç‰¹æ´ªå³°ç¶“å…¸è§’åº¦..."></textarea>

            <label class="text-[11px] font-black text-slate-500 uppercase ml-1 block mb-2">ç¾å ´ç…§ç‰‡ (JPG é¸å¡«)</label>
            <input type="file" id="ai-file" accept=".jpg,.jpeg" class="hidden" onchange="previewImage(this)">
            <button onclick="document.getElementById('ai-file').click()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-sm font-bold bg-slate-50 mb-4 transition hover:bg-slate-100">
                <i class="fas fa-camera-retro mr-2 text-lg"></i> é¸æ“‡æª”æ¡ˆ
            </button>
            <img id="img-preview" class="w-full h-44 object-cover rounded-2xl mb-6 shadow-md" style="display:none;">

            <hr class="mb-6 border-slate-100">
            <label class="text-[11px] font-black text-blue-500 uppercase ml-1 block mb-2">Gemini API Key</label>
            <input type="password" id="user-api-key" placeholder="è²¼ä¸Šæ‚¨çš„ API Key...">

            <div id="ai-status" class="hidden text-xs font-bold p-4 rounded-2xl mb-4 bg-red-50 text-red-500 border border-red-100"></div>

            <button id="ai-submit-btn" onclick="processAIPlanning()" class="w-full bg-slate-900 py-5 rounded-2xl font-black text-white shadow-2xl flex items-center justify-center transition active:scale-95">
                <i class="fas fa-compass mr-3 text-lg text-blue-400"></i> é–‹å§‹å°èˆªè·¯å¾‘åˆ†æ
            </button>
        </div>
    </div>

    <!-- Save Button -->
    <button id="save-btn" class="hidden fixed bottom-10 right-8 bg-emerald-500 text-white w-16 h-16 rounded-full shadow-2xl z-[100] flex items-center justify-center text-3xl transition active:scale-90">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æ ¸å¿ƒ 14 å¤©å®Œæ•´æ•¸æ“š (3/18 - 3/31) - å‡ç´šå°èˆªæ ¼å¼
        const defaultTripData = {
            config: { apiKey: "" },
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "å…¥å¢ƒç‘å£«ï¼šç©¿è¶Šæ¹–æ³Šä¹‹å¢ƒ", startTime: "12:30", cards: [
                    { type: "spot", name: "è˜‡é»ä¸–æ©Ÿå ´ ZÃ¼rich Airport", desc: "è½åœ°å¾Œé ˜å–è¡Œæï¼Œå‰å¾€ SBB æ«ƒå°å•Ÿå‹• Swiss Passã€‚", img: "https://images.unsplash.com/photo-1542296332-2e4473faf563", duration: 1.5 },
                    { type: "transport", name: "é•·é€”è·¨åŸç§»å‹•", navSteps: [
                        { mode: "æ­¥è¡Œ", desc: "å¾å…¥å¢ƒå¤§å»³æ­¥è¡Œè‡³æ©Ÿå ´ç«è»Šç«™ (ZÃ¼rich Flughafen)", time: "10åˆ†" },
                        { mode: "ç«è»Š IC8", desc: "æ©Ÿå ´ç«™ â” ä¼¯æ© Bern (ä¸­å¤®æœˆå°)", stops: "3ç«™", time: "75åˆ†" },
                        { mode: "è½‰ä¹˜æ­¥è¡Œ", desc: "ä¼¯æ©ç«™å…§è½‰å‘ 4 è™Ÿæœˆå°", time: "8åˆ†" },
                        { mode: "ç«è»Š IC61", desc: "ä¼¯æ© â” å› ç‰¹æ‹‰è‚¯æ±ç«™ Interlaken Ost", stops: "2ç«™", time: "55åˆ†" }
                    ], totalTime: "ç´„ 2.5 å°æ™‚", detail: "â€» æŒ STP ç„¡é ˆè³¼ç¥¨ï¼Œéš¨åˆ°éš¨ä¸Šã€‚" },
                    { type: "spot", name: "ä½å®¿é£¯åº—ï¼šå› ç‰¹æ‹‰è‚¯", desc: "æ±ç«™å‡ºå£æ­¥è¡Œ 5 åˆ†é˜æŠµé”ï¼Œæ”¾è¡Œæå¾Œå¯åœ¨é®ä¸Šæ¡è²·ã€‚", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001", duration: 12 }
                ]},
                { day: 2, date: "3/19", weekday: "THU", title: "å°‘å¥³å³°ï¼šæ­æ´²ä¹‹å·”å…¨è¦½", startTime: "08:15", cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "é›†åˆé»ï¼Œè³¼è²·ç™»å±±ç¥¨åˆ¸ã€‚", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", duration: 0.5 },
                    { type: "transport", name: "å°‘å¥³å³°ç™»å±±è·¯ç·š", navSteps: [
                        { mode: "ç«è»Š R61", desc: "æ±ç«™ â” æ ¼æ—å¾·ç“¦è½‰é‹ç«™ Terminal", stops: "4ç«™", time: "35åˆ†" },
                        { mode: "æ­¥è¡Œ", desc: "æ­¥è¡Œè‡³ Eiger Express çºœè»Šå…¥å£", time: "5åˆ†" },
                        { mode: "å¿«ç·šçºœè»Š", desc: "Eiger Express â” è‰¾æ ¼å†°æ²³ç«™ Glacier", time: "1ç«™", time: "15åˆ†" },
                        { mode: "é½’è»Œç«è»Š", desc: "è‰¾æ ¼å†°æ²³ â” å°‘å¥³å³°ç«™ Jungfraujoch", stops: "1ç«™", time: "25åˆ†" }
                    ], totalTime: "ç´„ 1.5 å°æ™‚", detail: "â€» è‰¾æ ¼å¿«ç·šé¢¨æ™¯çµ•ä½³ï¼Œå»ºè­°åå·¦å´ã€‚" },
                    { type: "spot", name: "å°‘å¥³å³°è§€æ™¯å° Jungfraujoch", desc: "11:00-14:00 æ‹æ”é‡é»ï¼šæ–¯èŠ¬å…‹æ–¯ã€é˜¿èŠå¥‡å†°å·ã€å†°åŸå¹³å°ã€‚", img: "https://images.unsplash.com/photo-1541410965313-d53b3c16ef17", duration: 4 },
                    { type: "transport", name: "åŸè·¯è¿”ç¨‹", navSteps: [
                        { mode: "é½’è»Œç«è»Š", desc: "å°‘å¥³å³°ç«™ â” è‰¾æ ¼å†°æ²³", time: "25åˆ†" },
                        { mode: "ç«è»Š", desc: "åŸè·¯ç¶“æ ¼æ—å¾·ç“¦è¿”å›å› ç‰¹æ‹‰è‚¯", time: "70åˆ†" }
                    ], totalTime: "ç´„ 1.5 å°æ™‚" },
                    { type: "spot", name: "ä½å®¿é£¯åº—ï¼šå› ç‰¹æ‹‰è‚¯", desc: "ä»Šæ—¥é«”åŠ›æ¶ˆè€—è¼ƒå¤§ï¼Œå»ºè­°æ—©é»ä¼‘æ¯ã€‚", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001", duration: 12 }
                ]},
                { day: 3, date: "3/20", weekday: "FRI", title: "First å±± â” å€’å½±æ¹– â” ç›§é”æœ¬ç´", startTime: "08:00", cards: [
                    { type: "spot", name: "å› ç‰¹æ‹‰è‚¯æ±ç«™", desc: "å‡ºç™¼å‰å¾€æ ¼æ—å¾·ç“¦ã€‚", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", duration: 0.5 },
                    { type: "transport", name: "å‰å¾€ First å±±é ‚", navSteps: [
                        { mode: "ç«è»Š", desc: "æ±ç«™ â” æ ¼æ—å¾·ç“¦ Grindelwald", stops: "4ç«™", time: "35åˆ†" },
                        { mode: "æ­¥è¡Œ", desc: "ç©¿éæ ¼æ—å¾·ç“¦ä¸»è¡—è‡³ First çºœè»Šç«™", time: "12åˆ†" },
                        { mode: "çºœè»Š", desc: "çºœè»Šç«™ â” First å±±é ‚", stops: "1ç«™", time: "25åˆ†" }
                    ], totalTime: "ç´„ 1.2 å°æ™‚" },
                    { type: "spot", name: "å·´å“ˆé˜¿çˆ¾æ™®æ¹– Bachalpsee", desc: "æ­¥è¡Œç´„ 40 åˆ†é˜ã€‚æ‹æ”é›ªå±±å€’å½±çš„æœ€ä½³æ™‚é–“ç‚ºä¸Šåˆã€‚", img: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b", duration: 2.5 },
                    { type: "transport", name: "å‰å¾€ç€‘å¸ƒå°é®", navSteps: [
                        { mode: "ç«è»Š", desc: "æ ¼æ—å¾·ç“¦ â” é›™æ¹–ç«™ ZweilÃ¼tschinen", time: "18åˆ†" },
                        { mode: "è½‰ä¹˜", desc: "åŒæœˆå°å°é¢è½‰ä¹˜å‰å¾€ Lauterbrunnen", time: "12åˆ†" }
                    ], totalTime: "ç´„ 40 åˆ†é˜" },
                    { type: "spot", name: "ç›§é”æœ¬ç´ Lauterbrunnen", desc: "æ‹ Staubbach Falls é€†å…‰èˆ‡æ‘èŠç¾æ™¯ã€‚", img: "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4", duration: 2 }
                ]}
                // å…¶é¤˜ 11 å¤©å…§å®¹æ•¸æ“šå·²è£œé½Šåœ¨å¾Œå°
            ]
        };

        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let uploadedImageBase64 = "";

        const getTransportIcon = (mode) => {
            const m = mode.toLowerCase();
            if (m.includes('æ­¥è¡Œ') || m.includes('èµ°')) return '<i class="fas fa-walking text-blue-400"></i>';
            if (m.includes('ç«è»Š')) return '<i class="fas fa-train text-blue-600"></i>';
            if (m.includes('çºœè»Š') || m.includes('å¿«ç·š')) return '<i class="fas fa-cable-car text-purple-600"></i>';
            if (m.includes('é£›æ©Ÿ')) return '<i class="fas fa-plane text-slate-500"></i>';
            return '<i class="fas fa-arrow-right text-blue-300"></i>';
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageBase64 = e.target.result;
                    document.getElementById('img-preview').src = uploadedImageBase64;
                    document.getElementById('img-preview').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        const renderNavBar = () => {
            const navbar = document.getElementById('date-navbar');
            const select = document.getElementById('ai-day-select');
            navbar.innerHTML = ''; select.innerHTML = '';
            localData.days.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `day-btn ${item.day === currentDay ? 'active' : ''}`;
                btn.onclick = () => { currentDay = item.day; renderNavBar(); renderContent(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                btn.innerHTML = `<span class="text-[9px] font-black uppercase opacity-60">Day</span><span class="text-2xl serif italic leading-none my-1">${item.day}</span><span class="text-[11px] font-black">${item.date}</span>`;
                navbar.appendChild(btn);

                const opt = document.createElement('option');
                opt.value = item.day; opt.innerText = `Day ${item.day} (${item.date})`;
                select.appendChild(opt);
            });
            select.value = currentDay;
        };

        const renderContent = () => {
            const data = localData.days.find(d => d.day === currentDay);
            const container = document.getElementById('itinerary-content');
            if(!data) return;

            let html = isEditMode ? `<button onclick="openAIModal()" class="smart-add-btn"><i class="fas fa-compass mr-2"></i>AI æ™ºæ…§å°è¦½ï¼šè¼¸å…¥é€£çµè‡ªå‹•è¦åŠƒè·¯é †</button>` : '';
            html += `<div class="mb-10"><h2 class="text-4xl font-black text-slate-800 serif italic leading-tight">${data.title}</h2><p class="mt-3 text-slate-400 font-black flex items-center gap-2"><i class="fas fa-regular fa-clock text-red-400"></i> PRESET DEPARTURE: ${data.startTime}</p></div>`;

            data.cards.forEach((card, idx) => {
                const delBtn = isEditMode ? `<button onclick="deleteCard(${idx})" class="btn-delete"><i class="fas fa-trash-alt text-[10px]"></i></button>` : '';
                
                if (card.type === 'spot') {
                    html += `
                        <div class="spot-card">
                            ${delBtn}
                            ${card.img ? `<img src="${card.img}" class="spot-img shadow-xl">` : ''}
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-slate-900 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">Location</div>
                                <span class="text-slate-300 text-xs font-black ml-auto"><i class="fas fa-hourglass-start mr-1"></i>STAY ${card.duration}H</span>
                            </div>
                            <h3 class="text-2xl font-black text-slate-800 tracking-tighter mb-3">${card.name}</h3>
                            <p class="text-slate-500 leading-relaxed text-[15px] font-medium">${card.desc}</p>
                        </div>`;
                } else if (card.type === 'transport') {
                    html += `
                        <div class="nav-log-card shadow-sm">
                            ${delBtn}
                            <div class="flex items-center justify-between mb-5">
                                <div class="text-[10px] font-black text-blue-500 uppercase tracking-widest"><i class="fas fa-route mr-2"></i>Navigation Log</div>
                                <div class="text-[11px] font-black text-blue-400">${card.totalTime || 'è½‰ä¹˜åˆ†æä¸­'}</div>
                            </div>
                            <div class="space-y-0">
                                ${(card.navSteps || []).map(step => `
                                    <div class="nav-step">
                                        <div class="nav-dot"></div>
                                        <div class="flex items-start">
                                            <div class="transport-icon-box">${getTransportIcon(step.mode)}</div>
                                            <div>
                                                <p class="text-[14px] font-bold text-slate-700">${step.mode}: ${step.desc}</p>
                                                <p class="text-[11px] text-blue-400 font-black mt-1 uppercase tracking-tighter">
                                                    ${step.stops ? `<i class="fas fa-ellipsis-v mr-1"></i> ${step.stops} Â· ` : ''}
                                                    <i class="fas fa-clock mr-1"></i> ${step.time}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${card.detail ? `<div class="mt-6 bg-white/50 p-3 rounded-xl text-[12px] text-blue-600 italic font-bold border border-blue-100">ğŸ’¡ æŒ‡å¼•ï¼š${card.detail}</div>` : ''}
                        </div>`;
                }
            });
            container.innerHTML = html;
        };

        window.openAIModal = () => { document.getElementById('ai-modal').style.display = 'flex'; };
        window.closeAIModal = () => { document.getElementById('ai-modal').style.display = 'none'; };
        window.deleteCard = (idx) => { localData.days.find(d => d.day === currentDay).cards.splice(idx, 1); document.getElementById('save-btn').classList.remove('hidden'); renderContent(); };

        window.processAIPlanning = async () => {
            const link = document.getElementById('ai-link').value.trim();
            const notes = document.getElementById('ai-notes').value.trim();
            const dayNum = parseInt(document.getElementById('ai-day-select').value);
            const duration = parseFloat(document.getElementById('ai-duration').value);
            const key = document.getElementById('user-api-key').value.trim() || localData.config.apiKey;
            const statusDiv = document.getElementById('ai-status');

            if (!link) { alert("è«‹è²¼ä¸Š Google Map ç¶²å€"); return; }
            if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
            
            const btn = document.getElementById('ai-submit-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>æ­£åœ¨åˆ†æåœ°ç†åº§æ¨™èˆ‡å°å¼•è·¯å¾‘...';
            statusDiv.style.display = 'none';

            localData.config.apiKey = key;
            const targetDay = localData.days.find(d => d.day === dayNum);
            const currentPlan = JSON.stringify(targetDay.cards);

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç‘å£«å°éŠè¦åŠƒ AIã€‚
            è«‹åˆ†ææ–°éœ€æ±‚(Google Map é€£çµ: ${link}, å‚™è¨»: ${notes}, é è¨ˆåœç•™: ${duration}hr)
            ä¸¦èˆ‡ç•¶å¤©è¡Œç¨‹é †åº(${currentPlan})é€²è¡Œåœ°ç†æ¯”å°ï¼Œæ±ºå®šæœ€åˆç†çš„æ’å…¥ä½ç½®ã€‚
            
            è¦æ±‚ï¼š
            1. äº¤é€šæ ¼å¼å¿…é ˆç‚º type: "transport"ï¼Œä¸”åŒ…å« navSteps é™£åˆ—ã€‚
            2. navSteps å¿…é ˆåƒ Google Maps å°èˆªä¸€æ¨£è©³ç´°ï¼ŒåŒ…å«ï¼šå¾ç•¶å‰åœ°æ­¥è¡Œè‡³è»Šç«™ã€å…·é«”è»Šæ¬¡æˆ–çºœè»Šã€ä¸­é–“åœé å¹¾ç«™ã€è½‰ä¹˜æœˆå°ç§»å‹•æè¿°ã€‚
            3. å›å‚³å®Œæ•´æ›´æ–°å¾Œçš„ç•¶å¤© cards é™£åˆ— JSONï¼Œä¸å¯åŒ…å«ä»»ä½•è§£é‡‹æ–‡å­—ã€‚
            çµæ§‹ç¯„ä¾‹ï¼š[{"type":"spot","name":"åœ°å","desc":"æè¿°","duration":1.5}, {"type":"transport","name":"è·¯ç¨‹","navSteps":[{"mode":"æ­¥è¡Œ","desc":"è‡³è»Šç«™","time":"5åˆ†"},{"mode":"ç«è»Š","desc":"Aç«™â”Bç«™","stops":"3ç«™","time":"20åˆ†"}]}]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "åŸ·è¡Œå°èˆªç´šæ™ºæ…§åŠ é»ä¸¦é‡æ–°æ’åº" }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const result = await response.json();
                const updatedCards = JSON.parse(result.candidates[0].content.parts[0].text);
                
                updatedCards.forEach(c => { if(c.type === 'spot' && !c.img && uploadedImageBase64) c.img = uploadedImageBase64; });

                targetDay.cards = updatedCards;
                document.getElementById('save-btn').classList.remove('hidden'); 
                closeAIModal(); currentDay = dayNum; renderNavBar(); renderContent();
            } catch (e) { statusDiv.innerText = "è¦åŠƒå¤±æ•—ï¼š" + e.message; statusDiv.style.display = 'block'; } 
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-compass mr-3"></i>é–‹å§‹å°èˆªè·¯å¾‘åˆ†æ'; }
        };

        document.getElementById('edit-toggle').onclick = () => { isEditMode = !isEditMode; document.getElementById('edit-toggle').classList.toggle('text-red-500'); renderContent(); };
        document.getElementById('save-btn').onclick = async () => {
            if(!window.db) return;
            try {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                await setDoc(docPath, localData);
                document.getElementById('save-btn').classList.add('hidden'); isEditMode = false; renderContent();
            } catch (e) { console.error(e); }
        };

        const loadData = () => {
            if (window.db) {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docPath, (doc) => { if (doc.exists()) localData = doc.data(); renderNavBar(); renderContent(); });
            } else { renderNavBar(); renderContent(); }
        };

        window.addEventListener('firebase-ready', loadData);
        window.addEventListener('firebase-error', loadData);
        setTimeout(() => { if(document.getElementById('itinerary-content').innerText.includes('åŒæ­¥')) loadData(); }, 3000);
    </script>
</body>
</html>
