<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swiss & Milan 2026 | 數位行程全紀錄</title>
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) { console.error("Firebase Config Error", e); }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'swiss-milan-2026';
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app);
            window.db = getFirestore(app);
            window.appId = appId;
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else { await signInAnonymously(window.auth); }
                    window.dispatchEvent(new CustomEvent('firebase-ready'));
                } catch (e) { window.dispatchEvent(new CustomEvent('firebase-error')); }
            };
            initAuth();
        } else { setTimeout(() => window.dispatchEvent(new CustomEvent('firebase-error')), 500); }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@600&display=swap');
        :root { --bg-base: #FDFCFB; --accent-transport: #5B84B1; --accent-spot: #D4A373; --accent-hotel: #8E7B6D; }
        body { background-color: var(--bg-base); color: #3D3D3D; font-family: 'Noto Sans TC', sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card { background: white; border-radius: 28px; width: 100%; margin-bottom: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.02); border: 1px solid rgba(230, 225, 218, 0.6); position: relative; }
        .transport-card { background: #F8FAFC; border: 1.5px dashed var(--accent-transport); }
        .spot-card { border-bottom: 6px solid var(--accent-spot); }
        .hotel-card { border-left: 10px solid var(--accent-hotel); }
        .arrow-divider { display: flex; justify-content: center; align-items: center; height: 40px; color: #E2E8F0; font-size: 1.5rem; }
        .day-btn { flex: 0 0 auto; width: 75px; height: 95px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 22px; transition: all 0.3s; background: transparent; }
        .day-btn.active { background: white; box-shadow: 0 6px 20px rgba(0,0,0,0.1); color: var(--accent-transport); transform: translateY(-3px); border: 1px solid #E2E8F0; }
        .step-list-item { position: relative; padding-left: 36px; border-left: 2px solid #CBD5E1; margin-left: 10px; margin-bottom: 16px; }
        .step-list-item::before { content: ''; position: absolute; left: -6px; top: 8px; width: 10px; height: 10px; background: var(--accent-transport); border-radius: 50%; }
        .btn-add { background: #F8FAFC; color: #94A3B8; width: 100%; padding: 12px; border-radius: 18px; border: 2px dashed #E2E8F0; font-weight: bold; margin: 10px 0; font-size: 13px; }
        .btn-delete { position: absolute; top: 12px; right: 12px; background: #fee2e2; color: #ef4444; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        input, textarea, select { background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 12px; width: 100%; font-size: 15px; margin-bottom: 10px; }
        .text-detail { font-size: 15px; line-height: 1.6; }
        .text-title { font-size: 22px; font-weight: 700; }
        .preview-img { width: 100%; height: 180px; object-fit: cover; border-radius: 14px; margin-bottom: 12px; border: 1px solid #EEE; display: none; }
        .settings-btn { background: #E2E8F0; color: #64748B; padding: 8px; border-radius: 12px; font-size: 12px; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-24">

    <header class="sticky top-0 z-50 bg-[#FDFCFB]/95 backdrop-blur-md pt-8 pb-4 shadow-sm">
        <div class="px-5 mb-5 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extralight tracking-widest serif italic text-slate-700">The Archive.</h1>
                <p class="text-[12px] uppercase tracking-[0.4em] text-slate-400 mt-1 font-bold italic">2026 Journey Guide</p>
            </div>
            <div class="flex gap-2">
                <button id="settings-toggle" class="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
                <button id="edit-toggle" class="bg-slate-100 p-2.5 rounded-full text-slate-400 hover:text-emerald-500 transition">
                    <i class="fas fa-edit text-lg"></i>
                </button>
            </div>
        </div>
        <div class="flex overflow-x-auto no-scrollbar gap-4 px-5 pb-2" id="date-navbar"></div>
    </header>

    <main class="px-5 mt-6" id="itinerary-content">
        <div class="flex flex-col justify-center items-center py-40 text-slate-300">
            <i class="fas fa-circle-notch animate-spin text-5xl mb-6"></i>
            <p class="text-lg">同步雲端行程中...</p>
        </div>
    </main>

    <!-- AI Add Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-[36px] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-2xl font-bold serif text-slate-700">AI 導遊規劃</h3>
                <button onclick="closeAIModal()" class="text-slate-300 hover:text-slate-500 p-1"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <p class="text-slate-400 text-sm mb-6 font-medium italic">輸入目的地，AI 將為您串接完美的瀑布流路徑</p>
            
            <label class="text-[10px] font-black text-slate-500 uppercase ml-1 mb-1 block">目的地名稱 <span class="text-red-400">*</span></label>
            <input type="text" id="ai-dest" placeholder="例如：龍疆湖 (Lungern)">
            
            <label class="text-[10px] font-black text-slate-500 uppercase ml-1 mb-1 block">Google Maps 連結</label>
            <input type="text" id="ai-link" placeholder="貼上地圖分享連結">
            
            <label class="text-[10px] font-black text-slate-500 uppercase ml-1 mb-1 block">行程備註</label>
            <textarea id="ai-notes" rows="2" placeholder="備註您的特殊需求..."></textarea>

            <label class="text-[10px] font-black text-slate-500 uppercase ml-1 mb-1 block">現場照片 (JPG)</label>
            <div class="relative mb-4">
                <input type="file" id="ai-file" accept=".jpg,.jpeg" class="hidden" onchange="previewImage(this)">
                <button onclick="document.getElementById('ai-file').click()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-sm font-bold bg-slate-50 hover:bg-slate-100 transition">
                    <i class="fas fa-camera mr-2 text-lg"></i> 選擇拍攝照片
                </button>
                <img id="img-preview" class="preview-img mt-4 shadow-sm">
            </div>

            <button id="ai-submit-btn" onclick="processAIPlanning()" class="w-full bg-emerald-500 py-4 rounded-2xl font-bold text-white shadow-xl shadow-emerald-100 flex items-center justify-center mt-2">
                <i class="fas fa-magic mr-2"></i> 開始規劃並嵌入
            </button>
        </div>
    </div>

    <!-- API Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[201] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-[36px] p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">API 金鑰設定</h3>
            <p class="text-slate-400 text-sm mb-4">請貼入您的 Gemini API Key 以啟用手機端規劃功能：</p>
            <input type="password" id="user-api-key" placeholder="貼上金鑰...">
            <div class="flex gap-2 mt-4">
                <button onclick="closeSettings()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold">取消</button>
                <button onclick="saveApiKey()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold">儲存金鑰</button>
            </div>
            <button id="reset-trip-btn" onclick="resetToDefault()" class="w-full mt-4 bg-slate-700 text-white py-3 rounded-xl font-bold text-sm">恢復 14 天完整原始行程</button>
        </div>
    </div>

    <!-- Save Button -->
    <button id="save-btn" class="hidden fixed bottom-12 right-8 bg-emerald-500 text-white w-16 h-16 rounded-full shadow-2xl z-[100] flex items-center justify-center text-3xl transition transform active:scale-90">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>

    <script type="module">
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 核心 14 天完整數據 (3/18 - 3/31)
        const defaultTripData = {
            days: [
                { day: 1, date: "3/18", weekday: "WED", title: "蘇黎世入境 ➔ 因特拉肯", cards: [
                    { type: "hotel", name: "台北機場 (TPE)", desc: "00:20 EK0387。檢查 Swiss Pass。", img: "https://images.unsplash.com/photo-1542296332-2e4473faf563" },
                    { type: "transport", name: "移動路程", img: "https://images.unsplash.com/photo-1527668752968-14dc70a27c95", steps: [{mode: "飛機", route: "杜拜轉機 ➔ 12:25 抵達 ZRH", time: "12hr+"}, {mode: "火車", route: "蘇黎世機場 ➔ 因特拉肯", time: "2hr"}], detail: "建議搭乘景觀段欣賞龍疆湖。持 STP 刷 QR Code 上車。" },
                    { type: "hotel", name: "住：因特拉肯飯店", desc: "首晚入住。連住 5 晚。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 2, date: "3/19", weekday: "THU", title: "少女峰：歐洲之巔全覽", cards: [
                    { type: "hotel", name: "起點：因特拉肯飯店", desc: "穿著保暖。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "transport", name: "登山路線", img: "https://images.unsplash.com/photo-1531366930491-81529969ff3c", steps: [{mode: "火車 R61", route: "東站 ➔ 轉運站", time: "35m"}, {mode: "快線纜車", route: "Eiger Express", time: "15m"}, {mode: "齒軌火車", route: "艾格冰河 ➔ 少女峰站", time: "25m"}], detail: "11:00-14:00 拍攝熱點：阿萊奇冰川、冰原平台、斯芬克斯。" },
                    { type: "hotel", name: "終點：因特拉肯飯店", desc: "吃晚餐休息。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 3, date: "3/20", weekday: "FRI", title: "First 倒影 ➔ 盧達本納", cards: [
                    { type: "hotel", name: "起點：因特拉肯飯店", desc: "健行日，穿好鞋。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "transport", name: "前往 First 山頂", img: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48", steps: [{mode: "火車 R61", route: "Interlaken ➔ Grindelwald", time: "35m"}, {mode: "纜車", route: "Grindelwald ➔ First", time: "25m"}], detail: "健行 30-40 分鐘至巴哈阿爾普湖拍倒影。" },
                    { type: "spot", name: "巴哈阿爾普湖 Bachalpsee", img: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b", desc: "拍雪山倒影。優先搶無風時段拍照。" },
                    { type: "spot", name: "施陶巴赫瀑布 / 盧達本納", img: "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4", desc: "15:30-17:30 拍瀑布逆光。" },
                    { type: "hotel", name: "終點：因特拉肯飯店", desc: "休息。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 4, date: "3/21", weekday: "SAT", title: "米倫 ➔ 雪朗峰之旅", cards: [
                    { type: "hotel", name: "因特拉肯飯店", desc: "晨間計畫。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "transport", name: "登山纜車段", img: "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1", steps: [{mode: "火車+纜車", route: "Lauterbrunnen ➔ Mürren", time: "30m"}, {mode: "纜車", route: "Mürren ➔ Schilthorn", time: "20m"}], detail: "雪朗峰頂有 360 度觀景台。" },
                    { type: "hotel", name: "終點：因特拉肯飯店", desc: "休息。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 5, date: "3/22", weekday: "SUN", title: "施皮茨 ➔ 森林藍湖", cards: [
                    { type: "hotel", name: "因特拉肯飯店", desc: "悠閒週日。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "spot", name: "施皮茨城堡 Spiez", img: "https://images.unsplash.com/photo-1590494165264-1ebe3602eb80", desc: "拍攝城堡與湖景。" },
                    { type: "transport", name: "前往藍湖路程", img: "https://images.unsplash.com/photo-1627662056263-d73197607a7f", steps: [{mode: "火車+公車", route: "Spiez ➔ Frutigen ➔ Blausee", time: "40m"}], detail: "藍湖鱒魚料理必吃。" },
                    { type: "hotel", name: "住：因特拉肯飯店", desc: "最後一晚在因特拉肯。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 6, date: "3/23", weekday: "MON", title: "跨國移動 ➔ 米蘭", cards: [
                    { type: "hotel", name: "退房：因特拉肯飯店", desc: "行李移動到義大利。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "transport", name: "跨國快線路段", img: "https://images.unsplash.com/photo-1528150177508-7cc0c36cda5c", steps: [{mode: "火車", route: "Interlaken ➔ Spiez", time: "20m"}, {mode: "火車 EC", route: "Spiez ➔ Milano Centrale", time: "3.5h"}], detail: "EC 段必須事先劃位。下午米蘭逛街。" },
                    { type: "hotel", name: "住：米蘭飯店", desc: "首晚米蘭。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 7, date: "3/24", weekday: "TUE", title: "米蘭市區經典拍攝", cards: [
                    { type: "hotel", name: "米蘭飯店", desc: "早起避開觀光客。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "spot", name: "米蘭主教座堂 Duomo", img: "https://images.unsplash.com/photo-1528150177508-7cc0c36cda5c", desc: "下午光線最美。登頂拍攝尖塔與廣場。" },
                    { type: "hotel", name: "住：米蘭飯店", desc: "享受義式晚餐。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                ]},
                { day: 8, date: "3/25", weekday: "WED", title: "米蘭 ➔ 策馬特", cards: [
                    { type: "hotel", name: "米蘭飯店", desc: "早餐後出發。", img: "https://images.unsplash.com/photo-1520175480921-4edfa0683001" },
                    { type: "transport", name: "前往山城路程", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", steps: [{mode: "火車", route: "Milano ➔ Visp ➔ Zermatt", time: "3.5h"}], detail: "策馬特全區禁燃油車。" },
                    { type: "hotel", name: "住：策馬特飯店", desc: "連住 5 晚的第一晚。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" }
                ]},
                { day: 9, date: "3/26", weekday: "THU", title: "策馬特全時段攝影", cards: [
                    { type: "hotel", name: "策馬特飯店", desc: "準備攝影馬拉松。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" },
                    { type: "spot", name: "馬特洪峰：黃金日出", img: "https://images.unsplash.com/photo-1536431311719-398b6704d4cc", desc: "經典 Kirchbrücke 拍晨曦染色瞬間。" },
                    { type: "spot", name: "小鎮：藍調時刻", img: "https://images.unsplash.com/photo-1541410965313-d53b3c16ef17", desc: "傍晚教堂草坡拍小鎮燈火。" },
                    { type: "hotel", name: "住：策馬特飯店", desc: "休息。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" }
                ]},
                { day: 10, date: "3/27", weekday: "FRI", title: "Gornergrat ➔ 倒影湖", cards: [
                    { type: "hotel", name: "策馬特飯店", desc: "海拔攀升日。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" },
                    { type: "transport", name: "登山火車路段", img: "https://images.unsplash.com/photo-1538330621152-478f3d057e90", steps: [{mode: "火車 GGB", route: "Zermatt ➔ Gornergrat", time: "35m"}], detail: "上山坐右側看風景。" },
                    { type: "spot", name: "Riffelsee 倒影湖", img: "https://images.unsplash.com/photo-1518156677180-95a2893f3e9f", desc: "拍經典倒影的最佳點。" },
                    { type: "hotel", name: "住：策馬特飯店", desc: "第 3 晚。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" }
                ]},
                { day: 11, date: "3/28", weekday: "SAT", title: "蘇內加五湖健行", cards: [
                    { type: "hotel", name: "策馬特飯店", desc: "放鬆漫步。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" },
                    { type: "transport", name: "纜車路段", img: "https://images.unsplash.com/photo-1517400508447-f8dd518b86db", steps: [{mode: "地底纜車", route: "至 Sunnegga", time: "5m"}, {mode: "纜車", route: "至 Blauherd", time: "10m"}], detail: "步行至 Findeln 用餐。" },
                    { type: "hotel", name: "住：策馬特飯店", desc: "第 4 晚。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" }
                ]},
                { day: 12, date: "3/29", weekday: "SUN", title: "策馬特備用日", cards: [
                    { type: "hotel", name: "策馬特飯店", desc: "自由活動。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" },
                    { type: "spot", name: "小鎮購物補拍", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793", desc: "調整狀態。" },
                    { type: "hotel", name: "住：策馬特飯店", desc: "最後一晚。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" }
                ]},
                { day: 13, date: "3/30", weekday: "MON", title: "策馬特 ➔ 機場 ➔ 賦歸", cards: [
                    { type: "hotel", name: "退房：策馬特飯店", desc: "帶著回憶啟程。", img: "https://images.unsplash.com/photo-1533512930330-4ac257c86793" },
                    { type: "transport", name: "返程路程", img: "https://images.unsplash.com/photo-1542296332-2e4473faf563", steps: [{mode: "火車", route: "Zermatt ➔ Visp ➔ ZRH Airport", time: "4hr"}], detail: "3/31 抵台。" }
                ]},
                { day: 14, date: "3/31", weekday: "TUE", title: "平安抵達台灣", cards: [
                    { type: "hotel", name: "桃園機場 (TPE)", desc: "16:10 抵達。旅程結束。", img: "https://images.unsplash.com/photo-1542296332-2e4473faf563" }
                ]}
            ]
        };

        let currentDay = 1;
        let isEditMode = false;
        let localData = defaultTripData;
        let insertIndex = -1;
        let uploadedImageBase64 = "";
        let currentApiKey = typeof __api_key !== 'undefined' ? __api_key : "";

        const getTransportIcon = (mode) => {
            const m = mode.toLowerCase();
            if (m.includes('火車') || m.includes('train')) return '<i class="fas fa-train mr-3 text-blue-500 text-2xl"></i>';
            if (m.includes('纜車') || m.includes('cable')) return '<i class="fas fa-cable-car mr-3 text-purple-500 text-2xl"></i>';
            if (m.includes('步行') || m.includes('走')) return '<i class="fas fa-walking mr-3 text-emerald-500 text-2xl"></i>';
            if (m.includes('飛機')) return '<i class="fas fa-plane mr-3 text-slate-400 text-2xl"></i>';
            return '<i class="fas fa-chevron-right mr-3 text-slate-300 text-2xl"></i>';
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, width, height);
                        uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
                        const preview = document.getElementById('img-preview');
                        preview.src = uploadedImageBase64; preview.style.display = 'block';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        const renderNavBar = () => {
            const navbar = document.getElementById('date-navbar');
            navbar.innerHTML = '';
            localData.days.sort((a,b) => a.day - b.day).forEach(item => {
                const btn = document.createElement('button');
                btn.className = `day-btn ${item.day === currentDay ? 'active' : ''}`;
                btn.id = `day-btn-${item.day}`;
                btn.onclick = () => { 
                    currentDay = item.day; 
                    renderNavBar(); renderContent(); 
                    window.scrollTo({top: 0, behavior: 'smooth'}); 
                    document.getElementById(`day-btn-${item.day}`).scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                };
                btn.innerHTML = `<span class="text-[12px] font-black text-slate-400 opacity-60 uppercase">Day</span>
                                 <span class="text-3xl font-serif italic leading-none my-1">${item.day}</span>
                                 <span class="text-[14px] font-bold opacity-80">${item.date}</span>`;
                navbar.appendChild(btn);
            });
        };

        const renderContent = () => {
            const data = localData.days.find(d => d.day === currentDay);
            const container = document.getElementById('itinerary-content');
            if(!data) { container.innerHTML = `<p class="py-20 text-center text-slate-400">目前尚無內容。</p>`; return; }

            let html = `<div class="mb-10 fade-in"><p class="text-[16px] font-black text-slate-400 tracking-widest uppercase mb-1 italic">March ${data.date} (${data.weekday})</p><h2 class="text-4xl font-serif italic text-slate-700 leading-tight">${data.title}</h2></div>`;

            data.cards.forEach((card, idx) => {
                if (idx > 0) html += `<div class="arrow-divider"><i class="fas fa-chevron-down animate-bounce duration-[4000ms] text-slate-200"></i></div>`;
                const deleteBtn = isEditMode ? `<button onclick="deleteCard(${idx})" class="btn-delete shadow-lg"><i class="fas fa-trash-alt text-sm"></i></button>` : '';

                if (card.type === 'hotel') {
                    html += `<div class="card hotel-card shadow-lg p-10">${deleteBtn}<div class="h-44 bg-slate-100 bg-cover bg-center rounded-3xl mb-6 shadow-inner" style="background-image: url('${card.img}')"></div><h3 class="text-2xl font-bold text-slate-700">${card.name}</h3><p class="text-detail text-slate-400 mt-4 italic font-medium">${card.desc}</p></div>`;
                } else if (card.type === 'transport') {
                    html += `<div class="card transport-card shadow-sm p-10">${deleteBtn}<div class="h-40 bg-slate-100 bg-cover bg-center rounded-2xl mb-6 shadow-inner" style="background-image: url('${card.img}')"></div><div class="space-y-8 mb-8">${card.steps.map(s => `<div class="step-list-item"><div class="flex items-start">${getTransportIcon(s.mode)}<div><p class="text-[16px] font-bold text-slate-700">${s.mode}: ${s.route}</p><p class="text-[16px] text-slate-400 font-black mt-2">⏱️ ${s.time}</p></div></div></div>`).join('')}</div><div class="bg-blue-50/70 p-6 rounded-3xl text-blue-700 italic font-bold text-detail border border-blue-100">${card.detail}</div></div>`;
                } else if (card.type === 'spot') {
                    html += `<div class="card spot-card shadow-xl p-10">${deleteBtn}<div class="h-72 bg-slate-100 bg-cover bg-center rounded-[2.5rem] mb-8 shadow-xl" style="background-image: url('${card.img}')"></div><h3 class="text-3xl font-bold text-slate-700 serif tracking-tight">${card.name}</h3><p class="text-[16px] text-slate-500 mt-6 leading-relaxed font-medium">${card.desc}</p></div>`;
                }
                if (isEditMode) html += `<button onclick="openAIModal(${idx})" class="btn-add transition-all active:scale-95"><i class="fas fa-magic mr-2"></i>在此後新增 AI 規劃點</button>`;
            });
            container.innerHTML = html;
        };

        window.openAIModal = (idx) => { insertIndex = idx; document.getElementById('ai-modal').classList.remove('hidden'); document.body.style.overflow = 'hidden'; };
        window.closeAIModal = () => { document.getElementById('ai-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; uploadedImageBase64 = ""; document.getElementById('img-preview').style.display = 'none'; };
        window.deleteCard = (idx) => { const data = localData.days.find(d => d.day === currentDay); data.cards.splice(idx, 1); document.getElementById('save-btn').classList.remove('hidden'); renderContent(); };
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');
        window.saveApiKey = () => { currentApiKey = document.getElementById('user-api-key').value; closeSettings(); };
        window.resetToDefault = () => { if(confirm("確定要恢復 14 天完整行程嗎？這會蓋掉您目前的修改。")) { localData = JSON.parse(JSON.stringify(defaultTripData)); document.getElementById('save-btn').classList.remove('hidden'); renderNavBar(); renderContent(); closeSettings(); }};

        window.processAIPlanning = async () => {
            const dest = document.getElementById('ai-dest').value.trim();
            const link = document.getElementById('ai-link').value.trim();
            const notes = document.getElementById('ai-notes').value.trim();
            if (!dest) { alert("請輸入目的地名稱"); return; }
            if (!currentApiKey) { alert("請先點擊設定圖標貼入 Gemini API Key。"); return; }
            
            const btn = document.getElementById('ai-submit-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>AI 導遊分析中...';

            const currentDayObj = localData.days.find(d => d.day === currentDay);
            const prevSpot = currentDayObj.cards[insertIndex] ? currentDayObj.cards[insertIndex].name : "起始點";

            const userPrompt = `規劃從「${prevSpot}」到「${dest}」的路程。地圖：${link}。備註：${notes}`;
            const systemPrompt = `你是一位瑞士旅遊導覽 AI。請依資訊規劃路程，回傳 JSON 格式。結構：{"transport":{"steps":[{"mode":"火車/纜車/步行/快線","route":"轉乘路徑","time":"時間"}],"detail":"交通重點建議"},"spot":{"name":"地名","desc":"專業攝影位置描述"}}。`;

            try {
                const response = await retryWithBackoff(() => fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                }));
                const result = await response.json();
                const aiResult = JSON.parse(result.candidates[0].content.parts[0].text);

                currentDayObj.cards.splice(insertIndex + 1, 0, 
                    { type: "transport", name: `前往 ${aiResult.spot.name}`, img: "https://images.unsplash.com/photo-1527668752968-14dc70a27c95", steps: aiResult.transport.steps, detail: aiResult.transport.detail },
                    { type: "spot", name: aiResult.spot.name, desc: aiResult.spot.desc, img: uploadedImageBase64 || "https://images.unsplash.com/photo-1520175480921-4edfa0683001" }
                );
                document.getElementById('save-btn').classList.remove('hidden'); closeAIModal(); renderContent();
            } catch (e) { alert("AI 規劃失敗：" + e.message); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic mr-2"></i>開始規劃並寫入'; }
        };

        document.getElementById('edit-toggle').onclick = () => { isEditMode = !isEditMode; document.getElementById('edit-toggle').classList.toggle('text-emerald-500'); renderContent(); };
        document.getElementById('save-btn').onclick = async () => {
            if(!window.db) return;
            try {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                await setDoc(docPath, localData);
                document.getElementById('save-btn').classList.add('hidden'); isEditMode = false; renderContent();
            } catch (e) { alert("儲存失敗"); }
        };

        const loadData = () => {
            if (window.db) {
                const docPath = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'itinerary', 'master');
                onSnapshot(docPath, (doc) => { if (doc.exists()) localData = doc.data(); renderNavBar(); renderContent(); }, () => { renderNavBar(); renderContent(); });
            } else { renderNavBar(); renderContent(); }
        };

        window.addEventListener('firebase-ready', loadData);
        window.addEventListener('firebase-error', loadData);
        setTimeout(() => { if(document.getElementById('itinerary-content').innerText.includes('同步')) loadData(); }, 3000);
    </script>
</body>
</html>
